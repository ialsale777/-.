function onOpen() {
  const ui = SpreadsheetApp.getUi();

  // Ù‚Ø§Ø¦Ù…Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª
  ui.createMenu('ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª')
    .addItem('Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø§Ø¨Ù„ÙƒÙŠØ´Ù†', 'openUploadDialog_App')
    .addItem('Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„ØªØ£Ù…ÙŠÙ†', 'openUploadDialog_Insurance')
    .addItem('Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„ØªØ°Ø§ÙƒØ±', 'openUploadDialog_Tickets')
    .addItem('Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„ÙÙ†Ø§Ø¯Ù‚', 'openUploadDialog_Hotels')
    .addToUi();

  // Ù‚Ø§Ø¦Ù…Ø© Ø£Ø¯ÙˆØ§Øª Ù…Ø®ØµØµØ©
  ui.createMenu('ğŸ“… Ø£Ø¯ÙˆØ§Øª Ù…Ø®ØµØµØ©')
    .addItem('Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª', 'showDateTimePicker')
    .addToUi();

  // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø­Ø«
  ui.createMenu('ğŸ” Ø¨Ø­Ø«')
    .addItem('Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„', 'showPhoneSearchPopup')
    .addToUi();
}

// ğŸ—‚ï¸ Ø¯ÙˆØ§Ù„ ÙØªØ­ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù
function openUploadDialog_App()       { openUploadDialogWithType("Ø§Ù„Ø§Ø¨Ù„ÙƒÙŠØ´Ù†"); }
function openUploadDialog_Insurance() { openUploadDialogWithType("Ø§Ù„ØªØ£Ù…ÙŠÙ†"); }
function openUploadDialog_Tickets()   { openUploadDialogWithType("Ø§Ù„ØªØ°Ø§ÙƒØ±"); }
function openUploadDialog_Hotels()    { openUploadDialogWithType("Ø§Ù„ÙÙ†Ø§Ø¯Ù‚"); }

// ğŸ–¼ï¸ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù
function openUploadDialogWithType(columnName) {
  const template = HtmlService.createTemplateFromFile('UploadForm');
  template.columnTarget = columnName;
  const html = template.evaluate().setWidth(400).setHeight(300);
  SpreadsheetApp.getUi().showModalDialog(html, `Ø±ÙØ¹ Ù…Ù„Ù: ${columnName}`);
}

// ğŸ“¤ ØªÙ†ÙÙŠØ° Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ Google Drive
function uploadFileToDrive(data) {
  try {
    const folderId = folderMap[data.column];
    if (!folderId) return "âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¬Ù„Ø¯ Ù…Ø®ØµØµ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹: " + data.column;

    const folder = DriveApp.getFolderById(folderId);
    const blob = Utilities.newBlob(Utilities.base64Decode(data.base64), data.mimeType, data.fileName);
    const file = folder.createFile(blob);
    const fileUrl = file.getUrl();

    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    const activeRow = sheet.getActiveCell().getRow();
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    const targetCol = headers.indexOf(data.column);

    if (targetCol === -1) {
      return "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ " + data.column;
    }

    sheet.getRange(activeRow, targetCol + 1).setValue(fileUrl);
    return `âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ Ù…Ø¬Ù„Ø¯ "${data.column}" ÙˆØ­ÙÙØ¸ Ø§Ù„Ø±Ø§Ø¨Ø·.`;
  } catch (e) {
    return "âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¹: " + e.toString();
  }
}

// ğŸ“… Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª
function showDateTimePicker() {
  const html = HtmlService.createHtmlOutputFromFile('DateTimePicker')
    .setWidth(400)
    .setHeight(250);
  SpreadsheetApp.getUi().showModalDialog(html, 'Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª');
}

// â° Ø­ÙØ¸ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª ÙÙŠ Ø§Ù„Ø®Ù„ÙŠØ© Ø§Ù„Ù†Ø´Ø·Ø©
function setDateTime(dateTime) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  const cell = sheet.getActiveCell();
  cell.setValue(new Date(dateTime));
}
// ğŸ” ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„
function showPhoneSearchPopup() {
  const html = HtmlService.createHtmlOutputFromFile('PhoneSearch')
    .setWidth(400)
    .setHeight(200);
  SpreadsheetApp.getUi().showModalDialog(html, 'Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„');
}

// ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´ÙŠØªØ§Øª Ø¹Ù† Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„
function searchPhoneInSheets(phone) {
  if (!phone) return "âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£ÙˆÙ„Ø§Ù‹.";

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheets = ss.getSheets();
  const excluded = ["Ø§Ù„ÙˆØ±Ù‚Ø©6", "Ø¨Ø­Ø«", "ÙÙ‡Ø±Ø³ Ø§Ù„Ø¬ÙˆØ§Ø²Ø§Øª"];
  const cleanedPhone = phone.toString().replace(/^0+/, "").replace(/\s+/g, "");
  const matchingSheets = [];

  for (const sheet of sheets) {
    if (excluded.includes(sheet.getName())) continue;

    const data = sheet.getDataRange().getValues();
    const header = data[0];
    const phoneIndex = header.indexOf("Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„");
    if (phoneIndex === -1) continue;

    for (let i = 1; i < data.length; i++) {
      const rowPhone = (data[i][phoneIndex] || "").toString().replace(/^0+/, "").replace(/\s+/g, "");
      if (rowPhone === cleanedPhone) {
        matchingSheets.push(sheet.getName());
        break;
      }
    }
  }

  if (matchingSheets.length > 0) {
    return `âœ… Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ ${matchingSheets.length} ÙˆØ±Ù‚Ø©:<br>- ${matchingSheets.join('<br>- ')}`;
  }

  return "âŒ Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø£ÙŠ ÙˆØ±Ù‚Ø©.";
}
