// ğŸ—‚ï¸ Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª (Ø§Ø³ØªØ¨Ø¯Ù„Ù‡Ø§ Ø¨Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„ÙØ¹Ù„ÙŠØ© Ù…Ù† Google Drive)
const folderMap = {
  "Ø§Ù„Ø§Ø¨Ù„ÙƒÙŠØ´Ù†": "1xtXIHvfcRnVwQl8oEuzXl5M40uAnzVzV",
  "Ø§Ù„ØªØ£Ù…ÙŠÙ†": "18PNd5NTx-TjSGAojzCW8eoOgQV6SjwUF",
  "Ø§Ù„ØªØ°Ø§ÙƒØ±": "1qZdULT3dGKfdRC0pgN8JkOgXhMJahdwI",
  "Ø§Ù„ÙÙ†Ø§Ø¯Ù‚": "11s1I5y-aSK_fRC1Un0Wr5t0FJ5cKVBlM"
};

function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª')
    .addItem('Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø§Ø¨Ù„ÙƒÙŠØ´Ù†', 'openUploadDialog_App')
    .addItem('Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„ØªØ£Ù…ÙŠÙ†', 'openUploadDialog_Insurance')
    .addItem('Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„ØªØ°Ø§ÙƒØ±', 'openUploadDialog_Tickets')
    .addItem('Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„ÙÙ†Ø§Ø¯Ù‚', 'openUploadDialog_Hotels')
    .addToUi();
}

// Ø¯ÙˆØ§Ù„ Ù„ÙƒÙ„ Ù†ÙˆØ¹
function openUploadDialog_App()       { openUploadDialogWithType("Ø§Ù„Ø§Ø¨Ù„ÙƒÙŠØ´Ù†"); }
function openUploadDialog_Insurance() { openUploadDialogWithType("Ø§Ù„ØªØ£Ù…ÙŠÙ†"); }
function openUploadDialog_Tickets()   { openUploadDialogWithType("Ø§Ù„ØªØ°Ø§ÙƒØ±"); }
function openUploadDialog_Hotels()    { openUploadDialogWithType("Ø§Ù„ÙÙ†Ø§Ø¯Ù‚"); }

// Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
function openUploadDialogWithType(columnName) {
  const template = HtmlService.createTemplateFromFile('UploadForm');
  template.columnTarget = columnName;
  const html = template.evaluate().setWidth(400).setHeight(300);
  SpreadsheetApp.getUi().showModalDialog(html, `Ø±ÙØ¹ Ù…Ù„Ù: ${columnName}`);
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø±ÙØ¹
function uploadFileToDrive(data) {
  try {
    const folderId = folderMap[data.column];
    if (!folderId) return "âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¬Ù„Ø¯ Ù…Ø®ØµØµ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹: " + data.column;

    const folder = DriveApp.getFolderById(folderId);
    const blob = Utilities.newBlob(Utilities.base64Decode(data.base64), data.mimeType, data.fileName);
    const file = folder.createFile(blob);
    const fileUrl = file.getUrl();

    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    const activeRow = sheet.getActiveCell().getRow();
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    const targetCol = headers.indexOf(data.column);

    if (targetCol === -1) {
      return "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ " + data.column;
    }

    sheet.getRange(activeRow, targetCol + 1).setValue(fileUrl);
    return `âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ Ù…Ø¬Ù„Ø¯ "${data.column}" ÙˆØ­ÙÙØ¸ Ø§Ù„Ø±Ø§Ø¨Ø·.`;
  } catch (e) {
    return "âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¹: " + e.toString();
  }
}
