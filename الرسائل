function onEdit(e) {
  const sheet = e.source.getActiveSheet();
  const sheetName = sheet.getName();
  const row = e.range.getRow();
  const col = e.range.getColumn();

  if (sheetName === "الورقة6") return;

  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];

  const colNames = {
    "رسالة طلب تحضير الأوراق": "MS",
    "رسالة اقرار باستلام الورق": "MS1",
    "رسالة الموعد": "MS2",
    "رسالة تم التبصيم": "MS3",
    "رسالة استلام الجواز": "MS4"
  };

  for (const triggerColName in colNames) {
    const triggerIndex = headers.indexOf(triggerColName) + 1;
    if (col === triggerIndex) {
      const value = e.range.getValue();
      const statusIndex = headers.indexOf(colNames[triggerColName]) + 1;
      if (value === true) {
        sheet.getRange(row, statusIndex).setValue("🔁 جاهز");
      }
      break;
    }
  }
}
function checkAndSendAll() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const allSheets = ss.getSheets();

  const instanceId = "6795E5298DEC5";
  const accessToken = "66f85a4411dc4";

  allSheets.forEach(sheet => {
    const name = sheet.getName();
    if (name === "الورقة6") return;

    const data = sheet.getDataRange().getValues();
    const headers = data[0];

    const config = [
      { trigger: "رسالة طلب تحضير الأوراق", status: "MS", message: r => `مرحبًا، هذه رسالة طلب تحضير الأوراق من شركة تجوال. الرجاء تجهيز الأوراق المطلوبة. شكرًا لك.` },
      { trigger: "رسالة اقرار باستلام الورق", status: "MS1", message: r => `تم استلام أوراقك بنجاح. نشكرك على تعاونك مع شركة تجوال.` },
      { trigger: "رسالة الموعد", status: "MS2", message: r => `عزيزنا العميل، تم تحديد موعد حضورك لدى شركة تجوال في: ${r["تاريخ الموعد"]}.\nالرجاء الالتزام بالحضور في الوقت المحدد.` },
      {
  trigger: "رسالة تم التبصيم",
  status: "MS3",
  message: r => {
    const appNumber = r["رقم الأبلكيشن"]?.toString().trim();
    const refPart = appNumber ? `\n🔢 رقمك المرجعي: *${appNumber}*` : "";
    return `نشكرك على حضورك، تم تأكيد عملية التبصيم بنجاح.${refPart}\nنتمنى لك رحلة موفقة من شركة تجوال.`;
  }
},

      { trigger: "رسالة استلام الجواز", status: "MS4", message: r => `يسعدنا إبلاغك بأنه تم استلام الجواز الخاص بك من قبل شركة تجوال. شكرًا لتعاملك معنا.` }
    ];

    const phoneIndex = headers.indexOf("رقم الجوال");

    config.forEach(({ trigger, status, message }) => {
      const triggerIndex = headers.indexOf(trigger);
      const statusIndex = headers.indexOf(status);
      const dateIndex = headers.indexOf("تاريخ الموعد");

      if (triggerIndex === -1 || statusIndex === -1 || phoneIndex === -1) return;

      for (let i = 1; i < data.length; i++) {
        const row = data[i];
        const phoneRaw = row[phoneIndex];
        const statusValue = row[statusIndex];

        if (statusValue !== "🔁 جاهز" || !row[triggerIndex]) continue;

        let phone = phoneRaw.toString().trim().replace(/^0+/, "");
        if (!phone.startsWith("966")) phone = "966" + phone;

        const rowObj = {};
        headers.forEach((h, idx) => rowObj[h] = row[idx]);

        const msg = message(rowObj);

        const url = `https://app.arrivewhats.com/api/send?number=${phone}&type=text&message=${encodeURIComponent(msg)}&instance_id=${instanceId}&access_token=${accessToken}`;
        try {
          const res = UrlFetchApp.fetch(url, { method: "get" });
          const json = JSON.parse(res.getContentText());
          if (json.status === "success") {
  sheet.getRange(i + 1, statusIndex + 1).setValue("✅");
} else {
  sheet.getRange(i + 1, statusIndex + 1).setValue("❌");
}

        } catch (err) {
          sheet.getRange(i + 1, statusIndex + 1).setValue("❌");
        }
      }
    });
  });
}
