function onEdit(e) {
  const sheet = e.source.getActiveSheet();
  const sheetName = sheet.getName();
  const row = e.range.getRow();
  const col = e.range.getColumn();

  if (sheetName === "Ø§Ù„ÙˆØ±Ù‚Ø©6") return;

  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];

  const colNames = {
    "Ø±Ø³Ø§Ù„Ø© Ø§Ù‚Ø±Ø§Ø± Ø¨Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ÙˆØ±Ù‚": "MS1",
    "Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¹Ø¯": "MS2",
    "Ø±Ø³Ø§Ù„Ø© ØªÙ… Ø§Ù„ØªØ¨ØµÙŠÙ…": "MS3",
    "Ø±Ø³Ø§Ù„Ø© Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ø²": "MS4",
    "Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ£Ø¬ÙŠÙ„": "MS5"
  };

  for (const triggerColName in colNames) {
    const triggerIndex = headers.indexOf(triggerColName) + 1;
    if (col === triggerIndex) {
      const value = e.range.getValue();
      const statusIndex = headers.indexOf(colNames[triggerColName]) + 1;
      if (value === true) {
        sheet.getRange(row, statusIndex).setValue("ğŸ” Ø¬Ø§Ù‡Ø²");
      }
      break;
    }
  }
}

function checkAndSendAll() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const allSheets = ss.getSheets();

  allSheets.forEach(sheet => {
    const name = sheet.getName();
    if (name === "Ø§Ù„ÙˆØ±Ù‚Ø©6") return;

    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    const phoneIndex = headers.indexOf("Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„");

    const config = [
      {
        trigger: "Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¹Ø¯",
        status: "MS2",
        message: r => {
          const name = r["Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ø¬ÙˆØ§Ø²"]?.toString().trim() || "Ø¹Ù…ÙŠÙ„Ù†Ø§";
          const rawDate = r["ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙˆØ¹Ø¯"];
          let dateStr = "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
          let timeStr = "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";

          if (rawDate instanceof Date) {
            const tz = Session.getScriptTimeZone();
            const datePart = Utilities.formatDate(rawDate, tz, "yyyy/MM/dd");
            const timePart = Utilities.formatDate(rawDate, tz, "hh:mm");
            const meridian = Utilities.formatDate(rawDate, tz, "a");
            const meridianAr = meridian === "AM" ? "ØµØ¨Ø§Ø­Ù‹Ø§" : "Ù…Ø³Ø§Ø¡Ù‹";

            dateStr = datePart;
            timeStr = `${timePart} ${meridianAr}`;
          }

          return `ğŸ“… Ù…ÙˆØ¹Ø¯Ùƒ Ù„Ù„ØªØ¨ØµÙŠÙ… - ØªØ£Ø´ÙŠØ±Ø© Ø´Ù†ØºÙ† ğŸ‡ªğŸ‡º\n\n` +
                 `Ø¹Ø²ÙŠØ²ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„ *${name}*ØŒ\n\n` +
                 `ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹: Ù…ÙƒØªØ¨ ØªØ¬ÙˆØ§Ù„ Ù„Ù„Ø³ÙŠØ§Ø­Ø© â€“ Ø¨Ø±Ø¬ Ø§Ù„Ø­ÙˆÙŠØ²ÙŠ\n` +
                 `ğŸ“† Ø§Ù„ØªØ§Ø±ÙŠØ®: ${dateStr}\n` +
                 `ğŸ•˜ Ø§Ù„ÙˆÙ‚Øª: ${timeStr}\n\n` +
                 `ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø­Ø¶ÙˆØ± Ù‚Ø¨Ù„ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ù„Ø£Ø®Ø° Ø±Ù‚Ù….\n` +
                 `âš ï¸ Ù‡Ø°Ù‡ Ø±Ø³Ø§Ù„Ø© Ø¢Ù„ÙŠØ©ØŒ Ù„Ø§ ÙŠÙ„Ø²Ù… Ø§Ù„Ø±Ø¯.`;
        }
      },
      {
        trigger: "Ø±Ø³Ø§Ù„Ø© Ø§Ù‚Ø±Ø§Ø± Ø¨Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ÙˆØ±Ù‚",
        status: "MS1",
        message: r => `ğŸ“© *ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø£ÙˆØ±Ø§Ù‚*\n\nÙ…Ø±Ø­Ø¨Ù‹Ø§ *${r["Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ø¬ÙˆØ§Ø²"] || ""}*ØŒ\n\nØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­.\n\nâš ï¸ Ù‡Ø°Ù‡ Ø±Ø³Ø§Ù„Ø© Ø¢Ù„ÙŠØ©ØŒ Ù„Ø§ ÙŠÙ„Ø²Ù… Ø§Ù„Ø±Ø¯.`
      },
      {
        trigger: "Ø±Ø³Ø§Ù„Ø© ØªÙ… Ø§Ù„ØªØ¨ØµÙŠÙ…",
        status: "MS3",
        message: r => {
          const name = r["Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ø¬ÙˆØ§Ø²"]?.toString().trim() || "";
          const appNumber = r["Ø±Ù‚Ù… Ø§Ù„Ø£Ø¨Ù„ÙƒÙŠØ´Ù†"]?.toString().trim();
          const refPart = appNumber ? `\nğŸ”¢ Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ: *${appNumber}*` : "";
          return `Ø¹Ø²ÙŠØ²ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„ *${name}*ØŒ\n\nØªÙ… Ø§Ù„ØªØ¨ØµÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­.${refPart}\nÙ…Ø¯Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨ 12â€“15 ÙŠÙˆÙ… Ø¹Ù…Ù„.\nğŸ“© Ø³ÙŠØªÙ… Ø¥Ø´Ø¹Ø§Ø±Ùƒ Ø¹Ù†Ø¯ Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø¬ÙˆØ§Ø².\n\nâš ï¸ Ù‡Ø°Ù‡ Ø±Ø³Ø§Ù„Ø© Ø¢Ù„ÙŠØ©ØŒ Ù„Ø§ ÙŠÙ„Ø²Ù… Ø§Ù„Ø±Ø¯.`;
        }
      },
      {
        trigger: "Ø±Ø³Ø§Ù„Ø© Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ø²",
        status: "MS4",
        message: r => {
          const name = r["Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ø¬ÙˆØ§Ø²"]?.toString().trim() || "";
          return `Ø¹Ø²ÙŠØ²ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„ *${name}*ØŒ\n\nÙ†Ø±Ø¬Ùˆ Ø§Ù„ØªÙØ¶Ù„ Ø¨Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ø² Ù…Ù† Ù…ÙƒØªØ¨ "ØªØ¬ÙˆØ§Ù„ Ù„Ù„Ø³ÙŠØ§Ø­Ø©" â€“ Ø¨Ø±Ø¬ Ø§Ù„Ø­ÙˆÙŠØ²ÙŠ.\nğŸ•˜ Ù…Ù† 12:00 Ø¸Ù‡Ø±Ù‹Ø§ Ø­ØªÙ‰ 10:00 Ù…Ø³Ø§Ø¡Ù‹ (Ø¹Ø¯Ø§ Ø§Ù„Ø¬Ù…Ø¹Ø©)\nğŸ“ Ø§Ù„Ù…ÙˆØ¸Ù: Ù…ØµØ·ÙÙ‰ Ø´Ù„Ø¨ÙŠ\n\nâœˆï¸ Ù†ØªÙ…Ù†Ù‰ Ù„Ùƒ Ø±Ø­Ù„Ø© Ø³Ø¹ÙŠØ¯Ø©\nâš ï¸ Ù‡Ø°Ù‡ Ø±Ø³Ø§Ù„Ø© Ø¢Ù„ÙŠØ©ØŒ Ù„Ø§ ÙŠÙ„Ø²Ù… Ø§Ù„Ø±Ø¯.`;
        }
      },
      {
        trigger: "Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ£Ø¬ÙŠÙ„",
        status: "MS5",
        message: r => {
          const name = r["Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ø¬ÙˆØ§Ø²"]?.toString().trim() || "Ø¹Ù…ÙŠÙ„Ù†Ø§";
          const rawData = r["Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªØ£Ø¬ÙŠÙ„"];
          let dateStr = "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
          let embassy = "";

          if (typeof rawData === "string" && rawData.includes("-")) {
            const parts = rawData.split("-");
            embassy = parts[1]?.trim() || "";

            const rawDate = new Date(parts[0].trim());
            if (!isNaN(rawDate)) {
              const tz = Session.getScriptTimeZone();
              dateStr = Utilities.formatDate(rawDate, tz, "yyyy/MM/dd");
            }
          }

          return `ğŸ“¢ ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ¹Ø¯Ùƒ Ù„Ù„Ø¨ØµÙ…Ø© - ØªØ£Ø´ÙŠØ±Ø© Ø´Ù†ØºÙ† ğŸ‡ªğŸ‡º\n\n` +
                 `Ø¹Ø²ÙŠØ²ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„ *${name}*ØŒ\n\n` +
                 `ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹: Ù…ÙƒØªØ¨ ØªØ¬ÙˆØ§Ù„ Ù„Ù„Ø³ÙŠØ§Ø­Ø© â€“ Ø¨Ø±Ø¬ Ø§Ù„Ø­ÙˆÙŠØ²ÙŠ\n` +
                 `ğŸ›ï¸ Ø§Ù„Ø³ÙØ§Ø±Ø©: ${embassy || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©"}\n` +
                 `ğŸ“† Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯: ${dateStr}\n\n` +
                 `ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø·Ù„Ø¨Ùƒ Ù„ØªØ£ÙƒÙŠØ¯ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø£Ùˆ ØªÙˆØ¶ÙŠØ­ Ø¹Ø¯Ù… Ù…Ù†Ø§Ø³Ø¨ØªÙ‡ Ù„Ùƒ.\n\n` +
                 `âš ï¸ Ù‡Ø°Ù‡ Ø±Ø³Ø§Ù„Ø© Ø¢Ù„ÙŠØ©ØŒ Ù„Ø§ ÙŠÙ„Ø²Ù… Ø§Ù„Ø±Ø¯.`;
        }
      }
    ];

    config.forEach(({ trigger, status, message }) => {
      const triggerIndex = headers.indexOf(trigger);
      const statusIndex = headers.indexOf(status);
      if (triggerIndex === -1 || statusIndex === -1 || phoneIndex === -1) return;

      for (let i = 1; i < data.length; i++) {
        const row = data[i];
        const phoneRaw = row[phoneIndex];
        const statusValue = row[statusIndex];

        if (!row[triggerIndex]) continue;
        if (statusValue === "âœ…" || statusValue === "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„") continue;

        if (statusValue === "ğŸ” Ø¬Ø§Ù‡Ø²") {
          sheet.getRange(i + 1, statusIndex + 1).setValue("â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");
          SpreadsheetApp.flush();
          Logger.log(`â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ - ${phoneRaw}`);
        }

        let phone = phoneRaw.toString().trim().replace(/^0+/, "");
        if (!phone.startsWith("966")) phone = "966" + phone;

        const rowObj = {};
        headers.forEach((h, idx) => rowObj[h] = row[idx]);

        const msg = message(rowObj);

        const body = {
          number: phone,
          text: msg
        };

        const options = {
          method: 'post',
          contentType: 'application/json',
          headers: {
            'apikey': '878559AC4207-4520-A544-80D3FEB9ED9B'
          },
          payload: JSON.stringify(body),
          muteHttpExceptions: true
        };

        try {
          const response = UrlFetchApp.fetch("https://w.eh4.me/message/sendText/ABD1", options);
          const json = JSON.parse(response.getContentText());
          const result = (json.status === "PENDING" || json.status === "success") ? "âœ…" : "âŒ";
          sheet.getRange(i + 1, statusIndex + 1).setValue(result);
          Logger.log(`ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ ${phone} | ${result} | ${trigger}`);

          if (trigger === "Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¹Ø¯" || trigger === "Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ£Ø¬ÙŠÙ„") {
            Utilities.sleep(Math.floor(Math.random() * (15000 - 5000 + 1)) + 5000);
          }
        } catch (err) {
          sheet.getRange(i + 1, statusIndex + 1).setValue("âŒ");
          Logger.log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ ${phone}: ${err.message}`);
        }
      }
    });
  });
}
