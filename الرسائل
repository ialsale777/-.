function onEdit(e) {
  const sheet = e.source.getActiveSheet();
  const sheetName = sheet.getName();
  const row = e.range.getRow();
  const col = e.range.getColumn();

  if (sheetName === "Ø§Ù„ÙˆØ±Ù‚Ø©6") return;

  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];

  const colNames = {
    "Ø±Ø³Ø§Ù„Ø© Ø·Ù„Ø¨ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø£ÙˆØ±Ø§Ù‚": "MS",
    "Ø±Ø³Ø§Ù„Ø© Ø§Ù‚Ø±Ø§Ø± Ø¨Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ÙˆØ±Ù‚": "MS1",
    "Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¹Ø¯": "MS2",
    "Ø±Ø³Ø§Ù„Ø© ØªÙ… Ø§Ù„ØªØ¨ØµÙŠÙ…": "MS3",
    "Ø±Ø³Ø§Ù„Ø© Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ø²": "MS4"
  };

  for (const triggerColName in colNames) {
    const triggerIndex = headers.indexOf(triggerColName) + 1;
    if (col === triggerIndex) {
      const value = e.range.getValue();
      const statusIndex = headers.indexOf(colNames[triggerColName]) + 1;
      if (value === true) {
        sheet.getRange(row, statusIndex).setValue("ğŸ” Ø¬Ø§Ù‡Ø²");
      }
      break;
    }
  }
}
function checkAndSendAll() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const allSheets = ss.getSheets();

  const instanceId = "6795E5298DEC5";
  const accessToken = "66f85a4411dc4";

  allSheets.forEach(sheet => {
    const name = sheet.getName();
    if (name === "Ø§Ù„ÙˆØ±Ù‚Ø©6") return;

    const data = sheet.getDataRange().getValues();
    const headers = data[0];

    const config = [
      { trigger: "Ø±Ø³Ø§Ù„Ø© Ø·Ù„Ø¨ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø£ÙˆØ±Ø§Ù‚", status: "MS", message: r => `Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ Ù‡Ø°Ù‡ Ø±Ø³Ø§Ù„Ø© Ø·Ù„Ø¨ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ù…Ù† Ø´Ø±ÙƒØ© ØªØ¬ÙˆØ§Ù„. Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©. Ø´ÙƒØ±Ù‹Ø§ Ù„Ùƒ.` },
      { trigger: "Ø±Ø³Ø§Ù„Ø© Ø§Ù‚Ø±Ø§Ø± Ø¨Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ÙˆØ±Ù‚", status: "MS1", message: r => `ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø£ÙˆØ±Ø§Ù‚Ùƒ Ø¨Ù†Ø¬Ø§Ø­. Ù†Ø´ÙƒØ±Ùƒ Ø¹Ù„Ù‰ ØªØ¹Ø§ÙˆÙ†Ùƒ Ù…Ø¹ Ø´Ø±ÙƒØ© ØªØ¬ÙˆØ§Ù„.` },
      { trigger: "Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¹Ø¯", status: "MS2", message: r => `Ø¹Ø²ÙŠØ²Ù†Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŒ ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆØ¹Ø¯ Ø­Ø¶ÙˆØ±Ùƒ Ù„Ø¯Ù‰ Ø´Ø±ÙƒØ© ØªØ¬ÙˆØ§Ù„ ÙÙŠ: ${r["ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙˆØ¹Ø¯"]}.\nØ§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ø­Ø¶ÙˆØ± ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯.` },
      {
  trigger: "Ø±Ø³Ø§Ù„Ø© ØªÙ… Ø§Ù„ØªØ¨ØµÙŠÙ…",
  status: "MS3",
  message: r => {
    const appNumber = r["Ø±Ù‚Ù… Ø§Ù„Ø£Ø¨Ù„ÙƒÙŠØ´Ù†"]?.toString().trim();
    const refPart = appNumber ? `\nğŸ”¢ Ø±Ù‚Ù…Ùƒ Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ: *${appNumber}*` : "";
    return `Ù†Ø´ÙƒØ±Ùƒ Ø¹Ù„Ù‰ Ø­Ø¶ÙˆØ±ÙƒØŒ ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ¨ØµÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­.${refPart}\nÙ†ØªÙ…Ù†Ù‰ Ù„Ùƒ Ø±Ø­Ù„Ø© Ù…ÙˆÙÙ‚Ø© Ù…Ù† Ø´Ø±ÙƒØ© ØªØ¬ÙˆØ§Ù„.`;
  }
},

      { trigger: "Ø±Ø³Ø§Ù„Ø© Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ø²", status: "MS4", message: r => `ÙŠØ³Ø¹Ø¯Ù†Ø§ Ø¥Ø¨Ù„Ø§ØºÙƒ Ø¨Ø£Ù†Ù‡ ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ø² Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø´Ø±ÙƒØ© ØªØ¬ÙˆØ§Ù„. Ø´ÙƒØ±Ù‹Ø§ Ù„ØªØ¹Ø§Ù…Ù„Ùƒ Ù…Ø¹Ù†Ø§.` }
    ];

    const phoneIndex = headers.indexOf("Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„");

    config.forEach(({ trigger, status, message }) => {
      const triggerIndex = headers.indexOf(trigger);
      const statusIndex = headers.indexOf(status);
      const dateIndex = headers.indexOf("ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙˆØ¹Ø¯");

      if (triggerIndex === -1 || statusIndex === -1 || phoneIndex === -1) return;

      for (let i = 1; i < data.length; i++) {
        const row = data[i];
        const phoneRaw = row[phoneIndex];
        const statusValue = row[statusIndex];

        if (statusValue !== "ğŸ” Ø¬Ø§Ù‡Ø²" || !row[triggerIndex]) continue;

        let phone = phoneRaw.toString().trim().replace(/^0+/, "");
        if (!phone.startsWith("966")) phone = "966" + phone;

        const rowObj = {};
        headers.forEach((h, idx) => rowObj[h] = row[idx]);

        const msg = message(rowObj);

        const url = `https://app.arrivewhats.com/api/send?number=${phone}&type=text&message=${encodeURIComponent(msg)}&instance_id=${instanceId}&access_token=${accessToken}`;
        try {
          const res = UrlFetchApp.fetch(url, { method: "get" });
          const json = JSON.parse(res.getContentText());
          if (json.status === "success") {
  sheet.getRange(i + 1, statusIndex + 1).setValue("âœ…");
} else {
  sheet.getRange(i + 1, statusIndex + 1).setValue("âŒ");
}

        } catch (err) {
          sheet.getRange(i + 1, statusIndex + 1).setValue("âŒ");
        }
      }
    });
  });
}
