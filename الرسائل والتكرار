// âœ… ØªÙ… ØªØ¹Ø·ÙŠÙ„ ÙƒÙˆØ¯ Ø§Ù„Ù†Ù‚Ù„ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ù…Ø¤Ù‚ØªÙ‹Ø§

function onEdit(e) {
  const sheet = e.source.getActiveSheet();
  const sheetName = sheet.getName();
  const range = e.range;
  const row = range.getRow();
  const col = range.getColumn();
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];

  if (sheetName === "Ø§Ù„ÙˆØ±Ù‚Ø©6") return;

  // âœ… ÙƒÙˆØ¯ Ø§Ù„ØªÙƒØ±Ø§Ø± Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ø²
  const passportColIndex = headers.indexOf("Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ø²");
  if (passportColIndex !== -1 && col === passportColIndex + 1 && row !== 1) {
    const editedValue = range.getValue()?.toString().trim().toLowerCase();
    if (editedValue) {
      const allSheets = e.source.getSheets();
      const currentSheetName = sheet.getName();
      let duplicateFound = false;
      let duplicateLocation = "";

      for (let s = 0; s < allSheets.length; s++) {
        const otherSheet = allSheets[s];
        const otherName = otherSheet.getName();
        if (otherName === currentSheetName || otherName === "Ø§Ù„ÙˆØ±Ù‚Ø©6") continue;

        const otherHeaders = otherSheet
          .getRange(1, 1, 1, otherSheet.getLastColumn())
          .getValues()[0];
        const otherPassportIndex = otherHeaders.indexOf("Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ø²");
        if (otherPassportIndex === -1) continue;

        const data = otherSheet
          .getRange(2, otherPassportIndex + 1, otherSheet.getLastRow() - 1)
          .getValues()
          .flat();
        const normalizedData = data.map((v) =>
          v.toString().trim().toLowerCase(),
        );

        if (normalizedData.includes(editedValue)) {
          duplicateFound = true;
          duplicateLocation = otherName;
          break;
        }
      }

      const currentData = sheet
        .getRange(2, passportColIndex + 1, sheet.getLastRow() - 1)
        .getValues()
        .flat();
      const normalizedCurrentData = currentData.map((v) =>
        v.toString().trim().toLowerCase(),
      );
      let duplicateInSameSheet =
        normalizedCurrentData.filter((v) => v === editedValue).length > 1;

      const cell = sheet.getRange(row, col);
      if (duplicateFound || duplicateInSameSheet) {
        cell.setBackground("#FFCDD2");
        let msg = "âš ï¸ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ø² Ù…ÙƒØ±Ø± ";
        if (duplicateFound) msg += `ÙÙŠ ÙˆØ±Ù‚Ø©: ${duplicateLocation} `;
        if (duplicateInSameSheet) msg += `(Ø£Ùˆ Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ø§Ù„ÙˆØ±Ù‚Ø©)`;
        SpreadsheetApp.getActive().toast(msg, "ØªØ­Ø°ÙŠØ±", 6);
      } else {
        cell.setBackground(null);
      }
    }
  }

  // âœ… ÙƒÙˆØ¯ Ø§Ù„ØªØ´ÙŠÙƒ Ø¨ÙˆÙƒØ³ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ù…Ø§ ÙÙŠÙ‡Ø§ "Ø·Ù„Ø¨ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø£ÙˆØ±Ø§Ù‚"
  const colNames = {
    "Ø±Ø³Ø§Ù„Ø© Ø·Ù„Ø¨ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø£ÙˆØ±Ø§Ù‚": "MS",
    "Ø±Ø³Ø§Ù„Ø© Ø§Ù†Ø°Ø§Ø±": "MS1",
    "Ø±Ø³Ø§Ù„Ø© Ø§Ù‚Ø±Ø§Ø± Ø¨Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ÙˆØ±Ù‚": "MS2",
    "Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¹Ø¯": "MS3",
    "Ø±Ø³Ø§Ù„Ø© ØªÙ… Ø§Ù„ØªØ¨ØµÙŠÙ…": "MS4",
    "Ø±Ø³Ø§Ù„Ø© Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ø²": "MS5",
    "ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…": "MS6",
    "Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ£Ø¬ÙŠÙ„": "MS7",
  };

  for (const triggerColName in colNames) {
    const triggerIndex = headers.indexOf(triggerColName) + 1;
    if (col === triggerIndex) {
      const value = range.getValue();
      const statusIndex = headers.indexOf(colNames[triggerColName]) + 1;
      if (value === true) {
        sheet.getRange(row, statusIndex).setValue("ğŸ” Ø¬Ø§Ù‡Ø²");
      }
      break;
    }
  }
}

function checkAndSendAll() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const allSheets = ss.getSheets();

  allSheets.forEach((sheet) => {
    const name = sheet.getName();
    if (name === "Ø§Ù„ÙˆØ±Ù‚Ø©6") return;

    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    const phoneIndex = headers.indexOf("Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„");

    const config = [
      {
        trigger: "Ø±Ø³Ø§Ù„Ø© Ø·Ù„Ø¨ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø£ÙˆØ±Ø§Ù‚",
        status: "MS",
        message: (r, sheetName) => {
          const name = r["Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ø¬ÙˆØ§Ø²"]?.toString().trim() || "";

          const isFrance = sheetName.toLowerCase().includes("france");
          const isSpain = sheetName.toLowerCase().includes("spain");

          if (isSpain) {
            return (
              `ğŸ“Œ Ù…ØªØ·Ù„Ø¨Ø§Øª ØªØ£Ø´ÙŠØ±Ø© Ø´Ù†ØºÙ†\n\n` +
              `Ù…Ø±Ø­Ø¨Ù‹Ø§ *${name}*ØŒ\n\n` +
              `Ù†Ø±Ø¬Ùˆ ØªØ³Ù„ÙŠÙ… Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„Ø¨Ø¯Ø¡ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ØªØ£Ø´ÙŠØ±ØªÙƒ:\n\n` +
              `1. ØµÙˆØ±ØªØ§Ù† Ø´Ø®ØµÙŠØ© Ø­Ø¯ÙŠØ«Ø© (3.5 Ã— 4.5) Ø¨Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡\n` +
              `2. Ø£ØµÙ„ Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ±\n` +
              `3. ØµÙˆØ±Ø© Ù…Ù† ØªØ£Ø´ÙŠØ±Ø© Ø´Ù†ØºÙ† Ø³Ø§Ø¨Ù‚Ø© (Ø¥Ù† ÙˆØ¬Ø¯Øª)\n` +
              `4. ØµÙˆØ±Ø© Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© / Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©\n` +
              `5. Ø®Ø·Ø§Ø¨ ØªØ¹Ø±ÙŠÙ Ø¨Ø§Ù„Ø¹Ù…Ù„ (Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©) ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰:\n` +
              `â€ƒ- Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ\n` +
              `â€ƒ- Ø§Ù„Ø±Ø§ØªØ¨\n` +
              `â€ƒ- ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù„ØªØ­Ø§Ù‚\n` +
              `â€ƒ- Ù…ØµØ¯Ù‚ Ù…Ù† Ø§Ù„ØºØ±ÙØ© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ© Ù„Ùˆ ÙƒØ§Ù† Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù…Ù„ Ù‚Ø·Ø§Ø¹ Ø®Ø§Øµ\n` +
              `6. ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø¨Ù†ÙƒÙŠ Ù„Ø¢Ø®Ø± 4 Ø£Ø´Ù‡Ø±:\n` +
              `â€ƒ- Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©\n` +
              `â€ƒ- Ù…Ø®ØªÙˆÙ… ÙˆØµØ§Ø¯Ø± Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ù†Ùƒ\n` +
              `7. Ø£Ù† Ù„Ø§ ÙŠÙ‚Ù„ Ø§Ù„Ø±ØµÙŠØ¯ Ø¹Ù† 10,000 Ø±ÙŠØ§Ù„ Ø§Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…ØªÙ‚Ø¯Ù… ÙØ±Ø¯ ÙˆÙ„Ùˆ ÙƒØ§Ù† Ø¹Ø§ÙŠÙ„Ø© ÙÙŠÙƒÙˆÙ†  10 Ø§Ù„Ø§Ù Ù„ÙƒÙ„ ÙØ±Ø¯ Ø¨Ø§Ù„Ø¹Ø§ÙŠÙ„Ø©\n` +
              `8. Ù†Ø³Ø®Ø© Ù…Ù† ÙƒØ±Øª Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© (Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³ÙØ± Ø¹Ø§Ø¦Ù„ÙŠ) *Ù…ØªØ±Ø¬Ù…*\n\n` +
              `ğŸ“© ÙŠØ±Ø¬Ù‰ ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ ÙÙŠ Ø£Ù‚Ø±Ø¨ ÙˆÙ‚Øª Ù…Ù…ÙƒÙ† Ù„ØªØ£ÙƒÙŠØ¯ Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø¨ØµÙ…Ø©.\n\n` +
              `âš ï¸ Ù‡Ø°Ù‡ Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø¢Ù„ÙŠØ© ÙˆÙ„Ø§ ÙŠØ¬Ø¨ Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§.`
            );
          }

          // Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙØ±Ù†Ø³ÙŠØ© (Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©)
          return (
            `ğŸ“Œ Ù…ØªØ·Ù„Ø¨Ø§Øª ØªØ£Ø´ÙŠØ±Ø© Ø´Ù†ØºÙ†\n\n` +
            `Ù…Ø±Ø­Ø¨Ù‹Ø§ *${name}*ØŒ\n\n` +
            `Ù†Ø±Ø¬Ùˆ ØªØ³Ù„ÙŠÙ… Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„Ø¨Ø¯Ø¡ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ØªØ£Ø´ÙŠØ±ØªÙƒ:\n\n` +
            `1. ØµÙˆØ±ØªØ§Ù† Ø´Ø®ØµÙŠØ© Ø­Ø¯ÙŠØ«Ø© (4 Ã— 5) Ø¨Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡ *Ù…Ø¹ Ø²ÙˆÙ… Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¬Ù‡*\n` +
            `2. Ø£ØµÙ„ Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ±\n` +
            `3. ØµÙˆØ±Ø© Ù…Ù† ØªØ£Ø´ÙŠØ±Ø© Ø´Ù†ØºÙ† Ø³Ø§Ø¨Ù‚Ø© (Ø¥Ù† ÙˆØ¬Ø¯Øª)\n` +
            `4. ØµÙˆØ±Ø© Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© / Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©\n` +
            `5. Ø®Ø·Ø§Ø¨ ØªØ¹Ø±ÙŠÙ Ø¨Ø§Ù„Ø¹Ù…Ù„ (Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©) ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰:\n` +
            `â€ƒ- Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ\n` +
            `â€ƒ- Ø§Ù„Ø±Ø§ØªØ¨\n` +
            `â€ƒ- ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù„ØªØ­Ø§Ù‚\n` +
            `â€ƒ- Ù…ØµØ¯Ù‚ Ù…Ù† Ø§Ù„ØºØ±ÙØ© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ© Ù„Ùˆ ÙƒØ§Ù† Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù…Ù„ Ù‚Ø·Ø§Ø¹ Ø®Ø§Øµ\n` +
            `6. ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø¨Ù†ÙƒÙŠ Ù„Ø¢Ø®Ø± 4 Ø£Ø´Ù‡Ø±:\n` +
            `â€ƒ- Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©\n` +
            `â€ƒ- Ù…Ø®ØªÙˆÙ… ÙˆØµØ§Ø¯Ø± Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ù†Ùƒ\n` +
            `7. Ø£Ù† Ù„Ø§ ÙŠÙ‚Ù„ Ø§Ù„Ø±ØµÙŠØ¯ Ø¹Ù† 10,000 Ø±ÙŠØ§Ù„ Ø§Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…ØªÙ‚Ø¯Ù… ÙØ±Ø¯ ÙˆÙ„Ùˆ ÙƒØ§Ù† Ø¹Ø§ÙŠÙ„Ø© ÙÙŠÙƒÙˆÙ† 10 Ø§Ù„Ø§Ù Ù„ÙƒÙ„ ÙØ±Ø¯ Ø¨Ø§Ù„Ø¹Ø§ÙŠÙ„Ø©\n` +
            `8. Ù†Ø³Ø®Ø© Ù…Ù† ÙƒØ±Øª Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© (Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³ÙØ± Ø¹Ø§Ø¦Ù„ÙŠ)\n\n` +
            `ğŸ“© ÙŠØ±Ø¬Ù‰ ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ ÙÙŠ Ø£Ù‚Ø±Ø¨ ÙˆÙ‚Øª Ù…Ù…ÙƒÙ† Ù„ØªØ£ÙƒÙŠØ¯ Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø¨ØµÙ…Ø©.\n\n` +
            `âš ï¸ Ù‡Ø°Ù‡ Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø¢Ù„ÙŠØ© ÙˆÙ„Ø§ ÙŠØ¬Ø¨ Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§.`
          );
        },
      },

      {
        trigger: "Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¹Ø¯",
        status: "MS3",
        message: (r) => {
          const name = r["Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ø¬ÙˆØ§Ø²"]?.toString().trim() || "Ø¹Ù…ÙŠÙ„Ù†Ø§";
          const rawDate = r["ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙˆØ¹Ø¯"];
          let dateStr = "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
          let timeStr = "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";

          if (rawDate instanceof Date) {
            const tz = Session.getScriptTimeZone();
            const datePart = Utilities.formatDate(rawDate, tz, "yyyy/MM/dd");
            const timePart = Utilities.formatDate(rawDate, tz, "hh:mm");
            const meridian = Utilities.formatDate(rawDate, tz, "a");
            const meridianAr = meridian === "AM" ? "ØµØ¨Ø§Ø­Ù‹Ø§" : "Ù…Ø³Ø§Ø¡Ù‹";

            dateStr = datePart;
            timeStr = `${timePart} ${meridianAr}`;
          }

          return (
            `ğŸ“… Ù…ÙˆØ¹Ø¯Ùƒ Ù„Ù„ØªØ¨ØµÙŠÙ… - ØªØ£Ø´ÙŠØ±Ø© Ø´Ù†ØºÙ† ğŸ‡ªğŸ‡º\n\n` +
            `Ø¹Ø²ÙŠØ²ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„ *${name}*ØŒ\n\n` +
            `ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹: Ù…ÙƒØªØ¨ ØªØ¬ÙˆØ§Ù„ Ù„Ù„Ø³ÙŠØ§Ø­Ø© â€“ Ø¨Ø±Ø¬ Ø§Ù„Ø­ÙˆÙŠØ²ÙŠ\n` +
            `ğŸ“† Ø§Ù„ØªØ§Ø±ÙŠØ®: ${dateStr}\n` +
            `ğŸ•˜ Ø§Ù„ÙˆÙ‚Øª: ${timeStr}\n\n` +
            `ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø­Ø¶ÙˆØ± Ù‚Ø¨Ù„ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ù„Ø£Ø®Ø° Ø±Ù‚Ù….\n` +
            `âš ï¸ Ù‡Ø°Ù‡ Ø±Ø³Ø§Ù„Ø© Ø¢Ù„ÙŠØ©ØŒ Ù„Ø§ ÙŠÙ„Ø²Ù… Ø§Ù„Ø±Ø¯.`
          );
        },
      },
      {
        trigger: "Ø±Ø³Ø§Ù„Ø© Ø§Ù‚Ø±Ø§Ø± Ø¨Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ÙˆØ±Ù‚",
        status: "MS2",
        message: (r) =>
          `ğŸ“© *ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø£ÙˆØ±Ø§Ù‚*\n\nÙ…Ø±Ø­Ø¨Ù‹Ø§ *${r["Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ø¬ÙˆØ§Ø²"] || ""}*ØŒ\n\nØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­.\n\nâš ï¸ Ù‡Ø°Ù‡ Ø±Ø³Ø§Ù„Ø© Ø¢Ù„ÙŠØ©ØŒ Ù„Ø§ ÙŠÙ„Ø²Ù… Ø§Ù„Ø±Ø¯.`,
      },
      {
        trigger: "Ø±Ø³Ø§Ù„Ø© ØªÙ… Ø§Ù„ØªØ¨ØµÙŠÙ…",
        status: "MS4",
        message: (r) => {
          const name = r["Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ø¬ÙˆØ§Ø²"]?.toString().trim() || "";
          const appNumber = r["Ø±Ù‚Ù… Ø§Ù„Ø£Ø¨Ù„ÙƒÙŠØ´Ù†"]?.toString().trim();
          const refPart = appNumber
            ? `\nğŸ”¢ Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ: *${appNumber}*`
            : "";
          return `Ø¹Ø²ÙŠØ²ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„ *${name}*ØŒ\n\nØªÙ… Ø§Ù„ØªØ¨ØµÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­.${refPart}\nÙ…Ø¯Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨ 12â€“15 ÙŠÙˆÙ… Ø¹Ù…Ù„.\nğŸ“© Ø³ÙŠØªÙ… Ø¥Ø´Ø¹Ø§Ø±Ùƒ Ø¹Ù†Ø¯ Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø¬ÙˆØ§Ø².\n\nâš ï¸ Ù‡Ø°Ù‡ Ø±Ø³Ø§Ù„Ø© Ø¢Ù„ÙŠØ©ØŒ Ù„Ø§ ÙŠÙ„Ø²Ù… Ø§Ù„Ø±Ø¯.`;
        },
      },
      {
        trigger: "Ø±Ø³Ø§Ù„Ø© Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ø²",
        status: "MS5",
        message: (r) => {
          const name = r["Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ø¬ÙˆØ§Ø²"]?.toString().trim() || "";
          const code = r["ÙƒÙˆØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…"]?.toString().trim() || "ØºÙŠØ± Ù…ØªÙˆÙØ±";
          return `Ø¹Ø²ÙŠØ²ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„ *${name}*ØŒ\n\nÙ†Ø±Ø¬Ùˆ Ø§Ù„ØªÙØ¶Ù„ Ø¨Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ø² Ù…Ù† Ù…ÙƒØªØ¨ "ØªØ¬ÙˆØ§Ù„ Ù„Ù„Ø³ÙŠØ§Ø­Ø©" â€“ Ø¨Ø±Ø¬ Ø§Ù„Ø­ÙˆÙŠØ²ÙŠ.\nğŸ•˜ Ù…Ù† 12:00 Ø¸Ù‡Ø±Ù‹Ø§ Ø­ØªÙ‰ 10:00 Ù…Ø³Ø§Ø¡Ù‹ (Ø¹Ø¯Ø§ Ø§Ù„Ø¬Ù…Ø¹Ø©)\nğŸ“ Ø§Ù„Ù…ÙˆØ¸Ù: Ù…ØµØ·ÙÙ‰ Ø´Ù„Ø¨ÙŠ\nğŸ” ÙƒÙˆØ¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ø²: *${code}*\n\nâœˆï¸ Ù†ØªÙ…Ù†Ù‰ Ù„Ùƒ Ø±Ø­Ù„Ø© Ø³Ø¹ÙŠØ¯Ø©\nâš ï¸ Ù‡Ø°Ù‡ Ø±Ø³Ø§Ù„Ø© Ø¢Ù„ÙŠØ©ØŒ Ù„Ø§ ÙŠÙ„Ø²Ù… Ø§Ù„Ø±Ø¯.`;
        },
      },
      {
        trigger: "ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…",
        status: "MS6",
        message: (r) => {
          const name = r["Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ø¬ÙˆØ§Ø²"]?.toString().trim() || "";
          return `ğŸ“¦ ØªÙ… ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø¬ÙˆØ§Ø² Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ *${name}* Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£Ø´ÙŠØ± Ø¹Ù„ÙŠÙ‡ âœ…\n\nÙ†ØªÙ…Ù†Ù‰ Ù„Ùƒ Ø±Ø­Ù„Ø© Ù…ÙˆÙÙ‚Ø© â¤ï¸\nâš ï¸ Ù‡Ø°Ù‡ Ø±Ø³Ø§Ù„Ø© Ø¢Ù„ÙŠØ©ØŒ Ù„Ø§ ÙŠÙ„Ø²Ù… Ø§Ù„Ø±Ø¯.`;
        },
      },

      {
        trigger: "Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ£Ø¬ÙŠÙ„",
        status: "MS7",
        message: (r) => {
          const name = r["Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ø¬ÙˆØ§Ø²"]?.toString().trim() || "Ø¹Ù…ÙŠÙ„Ù†Ø§";
          const rawData = r["Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªØ£Ø¬ÙŠÙ„"];
          let dateStr = "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
          let dayName = "";
          let embassy = "";

          const dayTranslations = {
            Sunday: "Ø§Ù„Ø£Ø­Ø¯",
            Monday: "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†",
            Tuesday: "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡",
            Wednesday: "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡",
            Thursday: "Ø§Ù„Ø®Ù…ÙŠØ³",
            Friday: "Ø§Ù„Ø¬Ù…Ø¹Ø©",
            Saturday: "Ø§Ù„Ø³Ø¨Øª",
          };

          if (typeof rawData === "string" && rawData.includes("-")) {
            const parts = rawData.split("-");
            embassy = parts[1]?.trim() || "";

            const rawDate = new Date(parts[0].trim());
            if (!isNaN(rawDate)) {
              const tz = Session.getScriptTimeZone();
              const engDay = Utilities.formatDate(rawDate, tz, "EEEE");
              dayName = dayTranslations[engDay] || engDay;
              dateStr = Utilities.formatDate(rawDate, tz, "yyyy/MM/dd");
            }
          }

          return (
            `ğŸ“¢ ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ¹Ø¯Ùƒ Ù„Ù„Ø¨ØµÙ…Ø© - ØªØ£Ø´ÙŠØ±Ø© Ø´Ù†ØºÙ† ğŸ‡ªğŸ‡º\n\n` +
            `Ø¹Ø²ÙŠØ²ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„ *${name}*ØŒ\n\n` +
            `ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹: Ù…ÙƒØªØ¨ ØªØ¬ÙˆØ§Ù„ Ù„Ù„Ø³ÙŠØ§Ø­Ø© â€“ Ø¨Ø±Ø¬ Ø§Ù„Ø­ÙˆÙŠØ²ÙŠ\n` +
            `ğŸ›ï¸ Ø§Ù„Ø³ÙØ§Ø±Ø©: ${embassy || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©"}\n` +
            `ğŸ“† Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯: *${dayName}* ${dateStr}\n\n` +
            `ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø·Ù„Ø¨Ùƒ Ù„ØªØ£ÙƒÙŠØ¯ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø£Ùˆ ØªÙˆØ¶ÙŠØ­ Ø¹Ø¯Ù… Ù…Ù†Ø§Ø³Ø¨ØªÙ‡ Ù„Ùƒ.\n\n` +
            `âš ï¸ Ù‡Ø°Ù‡ Ø±Ø³Ø§Ù„Ø© Ø¢Ù„ÙŠØ©ØŒ Ù„Ø§ ÙŠÙ„Ø²Ù… Ø§Ù„Ø±Ø¯.`
          );
        },
      },
      {
        trigger: "Ø±Ø³Ø§Ù„Ø© Ø§Ù†Ø°Ø§Ø±",
        status: "MS1",
        message: (r) => {
          const name = r["Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ø¬ÙˆØ§Ø²"]?.toString().trim() || "Ø¹Ù…ÙŠÙ„Ù†Ø§";
          return (
            `â° *ØªÙ†Ø¨ÙŠÙ‡ Ù…Ù‡Ù…*\n\n` +
            `Ø¹Ø²ÙŠØ²ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„ *${name}*ØŒ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù† Ù„Ù… Ù†Ø³ØªÙ„Ù… Ø£ÙˆØ±Ø§Ù‚Ùƒ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„ØªØ£Ø´ÙŠØ±Ø©.\n\n` +
            `Ù†ÙˆØ¯ Ø¥Ø¨Ù„Ø§ØºÙƒ Ø¨Ø£Ù† *ØºØ¯Ù‹Ø§ Ù‡Ùˆ Ø¢Ø®Ø± Ù…ÙˆØ¹Ø¯ Ù„ØªØ³Ù„ÙŠÙ… Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª* Ù„ØªÙØ§Ø¯ÙŠ Ø¥Ù„ØºØ§Ø¡ Ø£Ùˆ ØªØ£Ø¬ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¹Ø¯.`
          );
        },
      },
    ];

    config.forEach(({ trigger, status, message }) => {
      const triggerIndex = headers.indexOf(trigger);
      const statusIndex = headers.indexOf(status);
      if (triggerIndex === -1 || statusIndex === -1 || phoneIndex === -1)
        return;

      for (let i = 1; i < data.length; i++) {
        const row = data[i];
        const phoneRaw = row[phoneIndex];
        const statusValue = row[statusIndex];

        if (!row[triggerIndex]) continue;
        if (statusValue === "âœ…" || statusValue === "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„") continue;

        if (statusValue === "ğŸ” Ø¬Ø§Ù‡Ø²") {
          sheet.getRange(i + 1, statusIndex + 1).setValue("â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");
          SpreadsheetApp.flush();
          Logger.log(`â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ - ${phoneRaw}`);
        }

        let phone = phoneRaw.toString().trim().replace(/^0+/, "");
        if (!phone.startsWith("966")) phone = "966" + phone;

        const rowObj = {};
        headers.forEach((h, idx) => (rowObj[h] = row[idx]));

        const msg = message(rowObj, name); // Ù†Ø±Ø³Ù„ Ø§Ø³Ù… Ø§Ù„Ø´ÙŠØª

        const body = {
          number: phone,
          text: msg,
        };

        const options = {
          method: "post",
          contentType: "application/json",
          headers: {
            apikey: "878559AC4207-4520-A544-80D3FEB9ED9B",
          },
          payload: JSON.stringify(body),
          muteHttpExceptions: true,
        };

        try {
          const response = UrlFetchApp.fetch(
            "https://w.eh4.me/message/sendText/ABD1",
            options,
          );
          const json = JSON.parse(response.getContentText());
          const result =
            json.status === "PENDING" || json.status === "success"
              ? "âœ…"
              : "âŒ";
          sheet.getRange(i + 1, statusIndex + 1).setValue(result);
          Logger.log(`ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ ${phone} | ${result} | ${trigger}`);

          if (
            [
              "Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¹Ø¯",
              "Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ£Ø¬ÙŠÙ„",
              "Ø±Ø³Ø§Ù„Ø© Ø·Ù„Ø¨ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø£ÙˆØ±Ø§Ù‚",
            ].includes(trigger)
          ) {
            Utilities.sleep(
              Math.floor(Math.random() * (15000 - 5000 + 1)) + 5000,
            );
          }
        } catch (err) {
          sheet.getRange(i + 1, statusIndex + 1).setValue("âŒ");
          Logger.log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ ${phone}: ${err.message}`);
        }
      }
    });
  });
}
function checkDuplicatesManually() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheets = ss.getSheets();

  for (const sheet of sheets) {
    const sheetName = sheet.getName();
    if (sheetName === "Ø§Ù„ÙˆØ±Ù‚Ø©6") continue;

    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    const passportIndex = headers.indexOf("Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ø²");
    if (passportIndex === -1) continue;

    const allPassports = [];
    for (let i = 1; i < data.length; i++) {
      const val = data[i][passportIndex]?.toString().trim().toLowerCase();
      if (!val) continue;

      const cell = sheet.getRange(i + 1, passportIndex + 1);
      if (allPassports.includes(val)) {
        cell.setBackground("#FFCDD2"); // Ù…ÙƒØ±Ø± - Ø£Ø­Ù…Ø± ÙØ§ØªØ­
      } else {
        allPassports.push(val);
        cell.setBackground(null); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ„ÙˆÙŠÙ†
      }
    }
  }
}
