function manualRun() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet();
  const masterSheet = sheet.getSheetByName("Ø§Ù„ÙˆØ±Ù‚Ø©6");
  const allData = masterSheet.getDataRange().getValues();
  const header = allData[0];

  const passportIndex = header.indexOf("Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ø²");
  const dateIndex = header.indexOf("Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø¨ØµÙ…Ø©");
  let statusIndex = header.indexOf("ØªÙ… Ø§Ù„Ù†Ù‚Ù„");

  const startCol = 2;

  if (statusIndex === -1) {
    statusIndex = header.length;
    masterSheet.getRange(1, statusIndex + 1).setValue("ØªÙ… Ø§Ù„Ù†Ù‚Ù„");
  }

  const excludeColumns = ["ØªÙ… Ø§Ù„Ù†Ù‚Ù„", "Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø¨ØµÙ…Ø©"];
  const allowedHeader = header
    .map((col, idx) => ({ name: col, idx }))
    .filter((col) => col.idx >= startCol && !excludeColumns.includes(col.name));
  const allowedIndexes = allowedHeader.map(col => col.idx);
  let cleanHeader = allowedHeader.map(col => col.name);

  const birthDateIndexInAllowed = cleanHeader.indexOf("ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯");
  if (birthDateIndexInAllowed !== -1) {
    cleanHeader.splice(birthDateIndexInAllowed + 1, 0, "Ø§Ù„Ø¹Ù…Ø±");
  }

  for (let i = 1; i < allData.length; i++) {
    const row = allData[i];
    const passport = row[passportIndex];
    const date = row[dateIndex];
    const status = row[statusIndex];

    if (!passport || !date || status === "âœ…") continue;

    const sheetNameFull = date.toString().trim();
    const baseName = sheetNameFull.replace(/\(\d+\)/, '').trim();

    let target = sheet.getSheets().find(s => s.getName().startsWith(baseName));

    if (!target) {
      target = sheet.insertSheet(sheetNameFull);
      target.setFrozenRows(1);
      target.getRange(1, 1, 1, cleanHeader.length).setValues([cleanHeader]);

      for (let c = 0; c < cleanHeader.length; c++) {
        const originalIndex = (c <= birthDateIndexInAllowed)
          ? allowedIndexes[c]
          : allowedIndexes[c - 1];

        if (originalIndex !== undefined) {
          const sourceCell = masterSheet.getRange(1, originalIndex + 1);
          const targetCell = target.getRange(1, c + 1);
          sourceCell.copyTo(targetCell, SpreadsheetApp.CopyPasteType.PASTE_FORMAT, false);
          targetCell.setWrapStrategy(SpreadsheetApp.WrapStrategy.CLIP);
          const colWidth = masterSheet.getColumnWidth(originalIndex + 1);
          target.setColumnWidth(c + 1, colWidth);
        } else {
          target.setColumnWidth(c + 1, 100);
        }
      }
    }

    let passportExists = false;
    for (const currentSheet of sheet.getSheets()) {
      if (currentSheet.getName() === "Ø§Ù„ÙˆØ±Ù‚Ø©6") continue;
      const sheetData = currentSheet.getDataRange().getValues();
      const passportIdx = sheetData[0].indexOf("Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ø²");
      if (passportIdx !== -1 && sheetData.slice(1).some(r => r[passportIdx] === passport)) {
        passportExists = true;
        break;
      }
    }

    if (!passportExists) {
      const currentCount = target.getLastRow() - 1;
      const maxAllowed = parseInt((target.getName().match(/\((\d+)\)/) || [])[1]) || 30;

      if (currentCount >= maxAllowed) {
        SpreadsheetApp.getActive().toast(`âŒ ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ (${maxAllowed}) ÙÙŠ Ø§Ù„ÙˆØ±Ù‚Ø©: ${target.getName()}`, "ØªÙ†Ø¨ÙŠÙ‡", 6);
        continue;
      }

      let cleanRow = allowedIndexes.map(idx => row[idx]);

      let birthDateValue = cleanRow[birthDateIndexInAllowed];
      let age = "";
      if (typeof birthDateValue === "string") {
        birthDateValue = new Date(birthDateValue);
      }
      if (birthDateValue instanceof Date && !isNaN(birthDateValue)) {
        const today = new Date();
        age = today.getFullYear() - birthDateValue.getFullYear();
        const m = today.getMonth() - birthDateValue.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birthDateValue.getDate())) {
          age--;
        }
      }

      cleanRow.splice(birthDateIndexInAllowed + 1, 0, age);

      const targetRowNum = target.getLastRow() + 1;
      target.getRange(targetRowNum, 1, 1, cleanRow.length).setValues([cleanRow]);

      const checkboxCols = ["Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ£Ø¬ÙŠÙ„", "Ø±Ø³Ø§Ù„Ø© Ø§Ù‚Ø±Ø§Ø± Ø¨Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ÙˆØ±Ù‚", "Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¹Ø¯", "Ø±Ø³Ø§Ù„Ø© ØªÙ… Ø§Ù„ØªØ¨ØµÙŠÙ…", "Ø±Ø³Ø§Ù„Ø© Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ø²"];
      checkboxCols.forEach(colName => {
        const colIndex = cleanHeader.indexOf(colName);
        if (colIndex !== -1) target.getRange(targetRowNum, colIndex + 1).insertCheckboxes();
      });

      masterSheet.getRange(i + 1, statusIndex + 1).setValue("âœ…");

      const nameIndex = cleanHeader.indexOf("Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ø¬ÙˆØ§Ø²");
      const phoneIndex = cleanHeader.indexOf("Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„");
      const statusConfirmIndex = cleanHeader.indexOf("Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²");

      let confirmPhone = cleanRow[phoneIndex];
      let confirmName = cleanRow[nameIndex];
      if (confirmPhone && statusConfirmIndex !== -1) {
        confirmPhone = confirmPhone.toString().trim().replace(/^0+/, "");
        if (!confirmPhone.startsWith("966")) confirmPhone = "966" + confirmPhone;

        const visaDateMatch = sheetNameFull.match(/^(\d+)([A-Z]{3})/);
        let visaDate = "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
        if (visaDateMatch) {
          const day = visaDateMatch[1];
          const monthEng = visaDateMatch[2];
          const monthMap = {
            JAN: "ÙŠÙ†Ø§ÙŠØ±", FEB: "ÙØ¨Ø±Ø§ÙŠØ±", MAR: "Ù…Ø§Ø±Ø³", APR: "Ø£Ø¨Ø±ÙŠÙ„",
            MAY: "Ù…Ø§ÙŠÙˆ", JUN: "ÙŠÙˆÙ†ÙŠÙˆ", JUL: "ÙŠÙˆÙ„ÙŠÙˆ", AUG: "Ø£ØºØ³Ø·Ø³",
            SEP: "Ø³Ø¨ØªÙ…Ø¨Ø±", OCT: "Ø£ÙƒØªÙˆØ¨Ø±", NOV: "Ù†ÙˆÙÙ…Ø¨Ø±", DEC: "Ø¯ÙŠØ³Ù…Ø¨Ø±"
          };
          visaDate = `*${day} ${monthMap[monthEng] || monthEng}*`;
        }

        const message =
          `ğŸ“Œ Ù…Ø±Ø­Ø¨Ù‹Ø§ *${confirmName || ""}*ØŒ\n` +
          `ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø¨ØµÙ…Ø© Ø§Ù„Ø´Ù†ØºÙ† Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ø¨ØªØ§Ø±ÙŠØ® ${visaDate}.\n\n` +
          `Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…ÙˆØ¸Ù ÙÙŠ Ø­Ø§Ù„ Ø§Ù„Ø­Ø§Ø¬Ø© Ù„Ø£ÙŠ ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©.\n` +
          `âš ï¸ Ù‡Ø°Ù‡ Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø¢Ù„ÙŠØ© ÙˆÙ„Ø§ ÙŠØ¬Ø¨ Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§.`;

        const url = `https://app.arrivewhats.com/api/send?number=${confirmPhone}&type=text&message=${encodeURIComponent(message)}&instance_id=6795E5298DEC5&access_token=66f85a4411dc4`;

        let sendStatus = "âŒ";
        try {
          const response = UrlFetchApp.fetch(url, { method: "get" });
          const json = JSON.parse(response.getContentText());
          sendStatus = json.status === "success" ? "âœ…" : "âŒ";
        } catch (err) {}

        if (sendStatus === "âŒ") {
          Utilities.sleep(5000);
          try {
            const retryResponse = UrlFetchApp.fetch(url, { method: "get" });
            const retryJson = JSON.parse(retryResponse.getContentText());
            sendStatus = retryJson.status === "success" ? "âœ…" : "âŒ";
          } catch (retryErr) {}
        }

        target.getRange(targetRowNum, statusConfirmIndex + 1).setValue(sendStatus);

        Logger.log(
          `ğŸ“„ [${sheetNameFull}]\nğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${confirmName}\nğŸ“± Ø§Ù„Ø¬ÙˆØ§Ù„: ${confirmPhone}\nğŸ“¨ Ø§Ù„Ø­Ø§Ù„Ø©: ${sendStatus}\n---\n${message}\n==========================\n`
        );
      }
    }
  }
}

function retryFailedConfirmations() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const allSheets = ss.getSheets();

  const instanceId = "6795E5298DEC5";
  const accessToken = "66f85a4411dc4";

  allSheets.forEach(sheet => {
    const sheetName = sheet.getName();
    if (sheetName === "Ø§Ù„ÙˆØ±Ù‚Ø©6") return;

    const data = sheet.getDataRange().getValues();
    const headers = data[0];

    const phoneIndex = headers.indexOf("Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„");
    const nameIndex = headers.indexOf("Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ø¬ÙˆØ§Ø²");
    const statusIndex = headers.indexOf("Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²");

    if (phoneIndex === -1 || nameIndex === -1 || statusIndex === -1) return;

    const visaDateMatch = sheetName.match(/^(\d+)([A-Z]{3})/);
    let visaDate = "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
    if (visaDateMatch) {
      const day = visaDateMatch[1];
      const monthEng = visaDateMatch[2];
      const monthMap = {
        JAN: "ÙŠÙ†Ø§ÙŠØ±", FEB: "ÙØ¨Ø±Ø§ÙŠØ±", MAR: "Ù…Ø§Ø±Ø³", APR: "Ø£Ø¨Ø±ÙŠÙ„",
        MAY: "Ù…Ø§ÙŠÙˆ", JUN: "ÙŠÙˆÙ†ÙŠÙˆ", JUL: "ÙŠÙˆÙ„ÙŠÙˆ", AUG: "Ø£ØºØ³Ø·Ø³",
        SEP: "Ø³Ø¨ØªÙ…Ø¨Ø±", OCT: "Ø£ÙƒØªÙˆØ¨Ø±", NOV: "Ù†ÙˆÙÙ…Ø¨Ø±", DEC: "Ø¯ÙŠØ³Ù…Ø¨Ø±"
      };
      visaDate = `*${day} ${monthMap[monthEng] || monthEng}*`;
    }

    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const phoneRaw = row[phoneIndex];
      const name = row[nameIndex];
      const status = row[statusIndex];

      if (status !== "âŒ") continue;

      let phone = phoneRaw.toString().trim().replace(/^0+/, "");
      if (!phone.startsWith("966")) phone = "966" + phone;

      const message =
        `ğŸ“Œ Ù…Ø±Ø­Ø¨Ù‹Ø§ *${name || ""}*ØŒ\n` +
        `ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø¨ØµÙ…Ø© Ø§Ù„Ø´Ù†ØºÙ† Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ø¨ØªØ§Ø±ÙŠØ® ${visaDate}.\n\n` +
        `Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…ÙˆØ¸Ù ÙÙŠ Ø­Ø§Ù„ Ø§Ù„Ø­Ø§Ø¬Ø© Ù„Ø£ÙŠ ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©.\n` +
        `âš ï¸ Ù‡Ø°Ù‡ Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø¢Ù„ÙŠØ© ÙˆÙ„Ø§ ÙŠØ¬Ø¨ Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§.`;

      const url = `https://app.arrivewhats.com/api/send?number=${phone}&type=text&message=${encodeURIComponent(message)}&instance_id=${instanceId}&access_token=${accessToken}`;

      let sendStatus = "âŒ";
      try {
        const response = UrlFetchApp.fetch(url, { method: "get" });
        const json = JSON.parse(response.getContentText());
        sendStatus = json.status === "success" ? "âœ…" : "âŒ";
      } catch (err) {}

      sheet.getRange(i + 1, statusIndex + 1).setValue(sendStatus);

      Logger.log(
        `ğŸ“„ [${sheetName}]\nğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${name}\nğŸ“± Ø§Ù„Ø¬ÙˆØ§Ù„: ${phone}\nğŸ“¨ Ø§Ù„Ø­Ø§Ù„Ø©: ${sendStatus}\n---\n${message}\n==========================\n`
      );
    }
  });

  SpreadsheetApp.getUi().alert("âœ… ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©. Ø±Ø§Ø¬Ø¹ Logger Ù„Ù„ØªÙØ§ØµÙŠÙ„.");
}
