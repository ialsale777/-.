function manualRun() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet();
  const masterSheet = sheet.getSheetByName("Ø§Ù„ÙˆØ±Ù‚Ø©6");
  const allData = masterSheet.getDataRange().getValues();
  const header = allData[0];

  const passportIndex = header.indexOf("Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ø²");
  const dateIndex = header.indexOf("Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø¨ØµÙ…Ø©");
  let statusIndex = header.indexOf("ØªÙ… Ø§Ù„Ù†Ù‚Ù„");

  const startCol = 2;

  if (statusIndex === -1) {
    statusIndex = header.length;
    masterSheet.getRange(1, statusIndex + 1).setValue("ØªÙ… Ø§Ù„Ù†Ù‚Ù„");
  }

  const excludeColumns = ["ØªÙ… Ø§Ù„Ù†Ù‚Ù„", "Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø¨ØµÙ…Ø©"];
  const allowedHeader = header
    .map((col, idx) => ({ name: col, idx }))
    .filter((col) => col.idx >= startCol && !excludeColumns.includes(col.name));
  const allowedIndexes = allowedHeader.map(col => col.idx);
  let cleanHeader = allowedHeader.map(col => col.name);

  const birthDateIndexInAllowed = cleanHeader.indexOf("ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯");
  if (birthDateIndexInAllowed !== -1) {
    cleanHeader.splice(birthDateIndexInAllowed + 1, 0, "Ø§Ù„Ø¹Ù…Ø±");
  }

  for (let i = 1; i < allData.length; i++) {
    const row = allData[i];
    const passport = row[passportIndex];
    const date = row[dateIndex];
    const status = row[statusIndex];

    if (!passport || !date || status === "âœ…") continue;

    const sheetNameFull = date.toString().trim();
    const baseName = sheetNameFull.replace(/\(\d+\)/, '').trim();

    let target = sheet.getSheets().find(s => s.getName().startsWith(baseName));

    if (!target) {
      target = sheet.insertSheet(sheetNameFull);
      target.setFrozenRows(1);
      target.getRange(1, 1, 1, cleanHeader.length).setValues([cleanHeader]);

      for (let c = 0; c < cleanHeader.length; c++) {
        const originalIndex = (c <= birthDateIndexInAllowed)
          ? allowedIndexes[c]
          : allowedIndexes[c - 1];

        if (originalIndex !== undefined) {
          const sourceCell = masterSheet.getRange(1, originalIndex + 1);
          const targetCell = target.getRange(1, c + 1);
          sourceCell.copyTo(targetCell, SpreadsheetApp.CopyPasteType.PASTE_FORMAT, false);
          targetCell.setWrapStrategy(SpreadsheetApp.WrapStrategy.CLIP);
          const colWidth = masterSheet.getColumnWidth(originalIndex + 1);
          target.setColumnWidth(c + 1, colWidth);
        } else {
          target.setColumnWidth(c + 1, 100);
        }
      }
    }

    let passportExists = false;
    const allSheets = sheet.getSheets();
    for (let s = 0; s < allSheets.length; s++) {
      const currentSheet = allSheets[s];
      if (currentSheet.getName() === "Ø§Ù„ÙˆØ±Ù‚Ø©6") continue;

      const sheetData = currentSheet.getDataRange().getValues();
      const headerRow = sheetData[0];
      const passportIdx = headerRow.indexOf("Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ø²");

      if (passportIdx !== -1) {
        const passports = sheetData.slice(1).map(r => r[passportIdx]);
        if (passports.includes(passport)) {
          passportExists = true;
          break;
        }
      }
    }

    if (!passportExists) {
      const currentCount = target.getLastRow() - 1;
      const nameMatch = target.getName().match(/\((\d+)\)/);
      const maxAllowed = nameMatch ? parseInt(nameMatch[1], 10) : 30;

      if (currentCount >= maxAllowed) {
        SpreadsheetApp.getActive().toast(
          `âŒ ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ (${maxAllowed}) ÙÙŠ Ø§Ù„ÙˆØ±Ù‚Ø©: ${target.getName()}`,
          "ØªÙ†Ø¨ÙŠÙ‡",
          6
        );
        continue;
      }

      let cleanRow = allowedIndexes.map(idx => row[idx]);

      let birthDateValue = cleanRow[birthDateIndexInAllowed];
      let age = "";
      if (typeof birthDateValue === "string") {
        birthDateValue = new Date(birthDateValue);
      }
      if (birthDateValue instanceof Date && !isNaN(birthDateValue)) {
        const today = new Date();
        age = today.getFullYear() - birthDateValue.getFullYear();
        const m = today.getMonth() - birthDateValue.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birthDateValue.getDate())) {
          age--;
        }
      }

      cleanRow.splice(birthDateIndexInAllowed + 1, 0, age);

      const targetRowNum = target.getLastRow() + 1;
      target.getRange(targetRowNum, 1, 1, cleanRow.length).setValues([cleanRow]);

      const checkboxCols = [ "Ø±Ø³Ø§Ù„Ø© Ø§Ù‚Ø±Ø§Ø± Ø¨Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ÙˆØ±Ù‚", "Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¹Ø¯", "Ø±Ø³Ø§Ù„Ø© ØªÙ… Ø§Ù„ØªØ¨ØµÙŠÙ…", "Ø±Ø³Ø§Ù„Ø© Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ø²"];
      checkboxCols.forEach(colName => {
        const colIndex = cleanHeader.indexOf(colName);
        if (colIndex !== -1) {
          const cell = target.getRange(targetRowNum, colIndex + 1);
          cell.insertCheckboxes();
        }
      });

      const sourceRange = masterSheet.getRange(i + 1, 1, 1, cleanRow.length);
      const targetRange = target.getRange(targetRowNum, 1, 1, cleanRow.length);
      sourceRange.copyTo(targetRange, SpreadsheetApp.CopyPasteType.PASTE_FORMAT, false);

      targetRange.setTextDirection(SpreadsheetApp.TextDirection.RIGHT_TO_LEFT);

      masterSheet.getRange(i + 1, statusIndex + 1).setValue("âœ…");

      const nameIndex = cleanHeader.indexOf("Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ø¬ÙˆØ§Ø²");
      const phoneIndex = cleanHeader.indexOf("Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„");
      const statusConfirmIndex = cleanHeader.indexOf("Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²");

      let confirmPhone = cleanRow[phoneIndex];
      let confirmName = cleanRow[nameIndex];
      if (confirmPhone && statusConfirmIndex !== -1) {
        confirmPhone = confirmPhone.toString().trim().replace(/^0+/, "");
        if (!confirmPhone.startsWith("966")) confirmPhone = "966" + confirmPhone;

        const visaDateMatch = sheetNameFull.match(/^(\d+)([A-Z]{3})/);
        let visaDate = "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
        if (visaDateMatch) {
          const day = visaDateMatch[1];
          const monthEng = visaDateMatch[2];
          const monthMap = {
            JAN: "ÙŠÙ†Ø§ÙŠØ±", FEB: "ÙØ¨Ø±Ø§ÙŠØ±", MAR: "Ù…Ø§Ø±Ø³", APR: "Ø£Ø¨Ø±ÙŠÙ„",
            MAY: "Ù…Ø§ÙŠÙˆ", JUN: "ÙŠÙˆÙ†ÙŠÙˆ", JUL: "ÙŠÙˆÙ„ÙŠÙˆ", AUG: "Ø£ØºØ³Ø·Ø³",
            SEP: "Ø³Ø¨ØªÙ…Ø¨Ø±", OCT: "Ø£ÙƒØªÙˆØ¨Ø±", NOV: "Ù†ÙˆÙÙ…Ø¨Ø±", DEC: "Ø¯ÙŠØ³Ù…Ø¨Ø±"
          };
          visaDate = `*${day} ${monthMap[monthEng] || monthEng}*`;
        }

        const message =
          `ğŸ“Œ Ù…Ø±Ø­Ø¨Ù‹Ø§ *${confirmName || ""}*ØŒ\n` +
          `ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø¨ØµÙ…Ø© Ø§Ù„Ø´Ù†ØºÙ† Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ø¨ØªØ§Ø±ÙŠØ® ${visaDate}.\n\n` +
          `Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…ÙˆØ¸Ù ÙÙŠ Ø­Ø§Ù„ Ø§Ù„Ø­Ø§Ø¬Ø© Ù„Ø£ÙŠ ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©.\n` +
          `âš ï¸ Ù‡Ø°Ù‡ Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø¢Ù„ÙŠØ© ÙˆÙ„Ø§ ÙŠØ¬Ø¨ Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§.`;

        const url = `https://app.arrivewhats.com/api/send?number=${confirmPhone}&type=text&message=${encodeURIComponent(message)}&instance_id=6795E5298DEC5&access_token=66f85a4411dc4`;

        try {
          const response = UrlFetchApp.fetch(url, { method: "get" });
          const json = JSON.parse(response.getContentText());
          const status = json.status === "success" ? "âœ…" : "âŒ";
          target.getRange(targetRowNum, statusConfirmIndex + 1).setValue(status);

          // â¬‡ï¸ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù„ÙˆÙ‚ ÙÙŠ Ø´ÙŠØª Logs
          Logger.log(`ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²\nØ§Ù„Ø§Ø³Ù…: ${confirmName}\nØ§Ù„Ø¬ÙˆØ§Ù„: ${confirmPhone}\nØ§Ù„Ø­Ø§Ù„Ø©: ${status}\nØ§Ù„Ø±Ø³Ø§Ù„Ø©:\n${message}\n`);

          
        } catch (err) {
          target.getRange(targetRowNum, statusConfirmIndex + 1).setValue("âŒ");
        }
      }

      const ageCell = target.getRange(targetRowNum, birthDateIndexInAllowed + 2);
      if (typeof age === "number") {
        if (age < 6) {
          ageCell.setBackground("#FFF9C4");
        } else if (age < 12) {
          ageCell.setBackground("#BBDEFB");
        }
      }
    }
  }
}
