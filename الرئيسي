const EVOLUTION_API_URL = "https://w.eh4.me/message/sendText/ABD1";
const EVOLUTION_API_KEY = "878559AC4207-4520-A544-80D3FEB9ED9B";

function buildPassportMap(sheets, masterName = "Ø§Ù„ÙˆØ±Ù‚Ø©6") {
  const map = new Map();
  for (const s of sheets) {
    if (s.getName() === masterName) continue;
    const data = s.getDataRange().getValues();
    const header = data[0];
    const passportIndex = header.indexOf("Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ø²");
    if (passportIndex === -1) continue;
    for (let i = 1; i < data.length; i++) {
      const passport = data[i][passportIndex];
      if (passport) map.set(passport.toString().trim(), true);
    }
  }
  return map;
}

function manualRun() {
  Logger.log("ğŸš€ Ø¨Ø¯Ø£ ØªØ´ØºÙŠÙ„ manualRun");
  const sheet = SpreadsheetApp.getActiveSpreadsheet();
  const masterSheet = sheet.getSheetByName("Ø§Ù„ÙˆØ±Ù‚Ø©6");
  const allSheets = sheet.getSheets();
  const passportMap = buildPassportMap(allSheets);

  const allData = masterSheet.getDataRange().getValues();
  const header = allData[0];

  const passportIndex = header.indexOf("Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ø²");
  const dateIndex = header.indexOf("Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø¨ØµÙ…Ø©");
  let statusIndex = header.indexOf("ØªÙ… Ø§Ù„Ù†Ù‚Ù„");
  const startCol = 2;

  if (statusIndex === -1) {
    statusIndex = header.length;
    masterSheet.getRange(1, statusIndex + 1).setValue("ØªÙ… Ø§Ù„Ù†Ù‚Ù„");
  }

  const excludeColumns = ["ØªÙ… Ø§Ù„Ù†Ù‚Ù„", "Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø¨ØµÙ…Ø©"];
  const allowedHeader = header
    .map((col, idx) => ({ name: col, idx }))
    .filter((col) => col.idx >= startCol && !excludeColumns.includes(col.name));
  const allowedIndexes = allowedHeader.map(col => col.idx);
  let cleanHeader = allowedHeader.map(col => col.name);

  const birthDateIndexInAllowed = cleanHeader.indexOf("ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯");
  if (birthDateIndexInAllowed !== -1) {
    cleanHeader.splice(birthDateIndexInAllowed + 1, 0, "Ø§Ù„Ø¹Ù…Ø±");
  }

  // ğŸ”¢ Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ù…ÙƒÙ† ØªÙ†ÙÙŠØ°Ù‡Ø§ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  const MAX_ROWS_PER_RUN = 100;
  let processed = 0;

  for (let i = 1; i < allData.length; i++) {
  if (processed >= MAX_ROWS_PER_RUN) break;

  const row = allData[i];
  const passport = row[passportIndex];
  const date = row[dateIndex];
  const status = row[statusIndex];

  Logger.log(`ğŸ“‹ Ø§Ù„ØµÙ ${i + 1} | Ø¬ÙˆØ§Ø²: ${passport} | ØªØ§Ø±ÙŠØ®: ${date} | ØªÙ… Ø§Ù„Ù†Ù‚Ù„: ${status}`);

  if (!passport || !date || status === "âœ…") {
    Logger.log(`â­ï¸ ØªÙ… ØªØ®Ø·ÙŠ Ø§Ù„ØµÙ ${i + 1} Ù„Ø³Ø¨Ø¨: ${!passport ? "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¬ÙˆØ§Ø²" : !date ? "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ§Ø±ÙŠØ®" : "ØªÙ… Ø§Ù„Ù†Ù‚Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§"}`);
    continue;
  }

  if (passportMap.has(passport.toString().trim())) {
    Logger.log(`â­ï¸ ØªÙ… ØªØ®Ø·ÙŠ Ø§Ù„ØµÙ ${i + 1} Ù„Ø£Ù†Ù‡ Ù…ÙƒØ±Ø± ÙÙŠ ÙˆØ±Ù‚Ø© Ø£Ø®Ø±Ù‰`);
    continue;
  }

  // ØªØ§Ø¨Ø¹ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§

    if (processed >= MAX_ROWS_PER_RUN) break;

    try {
      const row = allData[i];
      const passport = row[passportIndex];
      const date = row[dateIndex];
      const status = row[statusIndex];

      if (!passport || !date || status === "âœ…") continue;
      if (passportMap.has(passport.toString().trim())) continue;

      const sheetNameFull = date.toString().trim();
      const baseName = sheetNameFull.replace(/\(\d+\)/, '').trim();

      let target = allSheets.find(s => s.getName().startsWith(baseName));
      if (!target) {
        target = sheet.insertSheet(sheetNameFull);
        target.setFrozenRows(1);
        const freezeUntil = cleanHeader.indexOf("ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¬ÙˆØ§Ø²") + 1;
        if (freezeUntil > 1) target.setFrozenColumns(freezeUntil);
        target.getRange(1, 1, 1, cleanHeader.length).setValues([cleanHeader]);

        for (let c = 0; c < cleanHeader.length; c++) {
          const originalIndex = (c <= birthDateIndexInAllowed)
            ? allowedIndexes[c]
            : allowedIndexes[c - 1];
          if (originalIndex !== undefined) {
            const sourceCell = masterSheet.getRange(1, originalIndex + 1);
            const targetCell = target.getRange(1, c + 1);
            sourceCell.copyTo(targetCell, SpreadsheetApp.CopyPasteType.PASTE_FORMAT, false);
            targetCell.setWrapStrategy(SpreadsheetApp.WrapStrategy.CLIP);
            target.setColumnWidth(c + 1, masterSheet.getColumnWidth(originalIndex + 1));
          } else {
            target.setColumnWidth(c + 1, 100);
          }
        }
      }

      const currentCount = target.getLastRow() - 1;
      const maxAllowed = parseInt((target.getName().match(/\((\d+)\)/) || [])[1]) || 30;
      if (currentCount >= maxAllowed) {
        SpreadsheetApp.getActive().toast(`âŒ ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ (${maxAllowed}) ÙÙŠ Ø§Ù„ÙˆØ±Ù‚Ø©: ${target.getName()}`, "ØªÙ†Ø¨ÙŠÙ‡", 6);
        continue;
      }

      let cleanRow = allowedIndexes.map(idx => row[idx]);

      // ğŸŸ¡ Ø§Ù„Ø¹Ù…Ø±
      let birthDateValue = cleanRow[birthDateIndexInAllowed];
      let age = "";
      if (typeof birthDateValue === "string") birthDateValue = new Date(birthDateValue);
      if (birthDateValue instanceof Date && !isNaN(birthDateValue)) {
        const today = new Date();
        age = today.getFullYear() - birthDateValue.getFullYear();
        const m = today.getMonth() - birthDateValue.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birthDateValue.getDate())) age--;
      }
      cleanRow.splice(birthDateIndexInAllowed + 1, 0, age);

      // ÙƒÙˆØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…
      const pickupCodeIndex = cleanHeader.indexOf("ÙƒÙˆØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…");
      if (pickupCodeIndex !== -1) {
        const randomCode = Math.floor(1000 + Math.random() * 9000);
        cleanRow.splice(pickupCodeIndex, 0, randomCode);
      }

      const targetRowNum = target.getLastRow() + 1;
// ğŸ“¤ Ù†Ø³Ø® Ø§Ù„ØµÙ Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©
target.getRange(targetRowNum, 1, 1, cleanRow.length).setValues([cleanRow]);


      // ØªÙ†Ø³ÙŠÙ‚Ø§Øª
      const formatSourceRange = masterSheet.getRange(2, startCol + 1, 1, cleanRow.length);
      const formatTargetRange = target.getRange(targetRowNum, 1, 1, cleanRow.length);
      formatSourceRange.copyTo(formatTargetRange, SpreadsheetApp.CopyPasteType.PASTE_FORMAT, false);

      const headers = target.getRange(1, 1, 1, target.getLastColumn()).getValues()[0];
      const ageColIndex = headers.findIndex(h => h.toString().trim() === "Ø§Ù„Ø¹Ù…Ø±");
      if (ageColIndex !== -1) {
        const ageCell = target.getRange(targetRowNum, ageColIndex + 1);
        const ageNum = parseInt(age, 10);
        ageCell.setValue(ageNum);
        if (!isNaN(ageNum)) {
          if (ageNum < 6) ageCell.setBackground("#FCE4EC");
          else if (ageNum < 12) ageCell.setBackground("#E8F5E9");
          else ageCell.setBackground("#FFFFFF");
        }
      }

      // Ù‚Ø§Ø¦Ù…Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ù…ÙˆØ¹Ø¯
      const changeColIndex = cleanHeader.indexOf("Ø¥Ø¬Ø±Ø§Ø¡ ØªØºÙŠÙŠØ± Ø§Ù„Ù…ÙˆØ¹Ø¯");
      if (changeColIndex !== -1) {
        const allSheetNames = allSheets.map(s => s.getName()).filter(n => n !== "Ø§Ù„ÙˆØ±Ù‚Ø©6");
        allSheetNames.push("Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…ÙˆØ¹Ø¯");
        const rule = SpreadsheetApp.newDataValidation()
          .requireValueInList(allSheetNames, true)
          .setAllowInvalid(false).build();
        const col = changeColIndex + 1;
        const targetRange = target.getRange(2, col, target.getLastRow() - 1);
        targetRange.setDataValidation(rule);
      }

      // âœ… Checkboxes
      const checkboxCols = [
        "Ø±Ø³Ø§Ù„Ø© Ø·Ù„Ø¨ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø£ÙˆØ±Ø§Ù‚",
        "Ø¥Ù†Ø°Ø§Ø± ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø£ÙˆØ±Ø§Ù‚",
        "Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ£Ø¬ÙŠÙ„",
        "Ø±Ø³Ø§Ù„Ø© Ø§Ù‚Ø±Ø§Ø± Ø¨Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ÙˆØ±Ù‚",
        "Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¹Ø¯",
        "Ø±Ø³Ø§Ù„Ø© ØªÙ… Ø§Ù„ØªØ¨ØµÙŠÙ…",
        "Ø±Ø³Ø§Ù„Ø© Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ø²",
        "ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…",
        "Ø±Ø³Ø§Ù„Ø© ØªØ­Ø°ÙŠØ± Ø¨Ø§Ù„Ø¬ÙˆØ§Ø²"

      ];
      checkboxCols.forEach(colName => {
        const colIndex = cleanHeader.indexOf(colName);
        if (colIndex !== -1) target.getRange(targetRowNum, colIndex + 1).insertCheckboxes();
      });

    Logger.log("ğŸ“ Ù‚Ø¨Ù„ ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© âœ…");
try {
  masterSheet.getRange(i + 1, statusIndex + 1).setValue("âœ…");
} catch (e) {
  Logger.log("ğŸš« Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø®Ù„ÙŠØ©: " + e.message);
}
Logger.log("ğŸ“ Ø¨Ø¹Ø¯ ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© âœ…");

      processed++;
    } catch (err) {
      Logger.log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØµÙ ${i + 1}: ${err.message}`);
    }
  }
}
