const EVOLUTION_API_URL = "https://w.eh4.me/message/sendText/ABD1";
const EVOLUTION_API_KEY = "878559AC4207-4520-A544-80D3FEB9ED9B";

function manualRun() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet();
  const masterSheet = sheet.getSheetByName("Ø§Ù„ÙˆØ±Ù‚Ø©6");
  const allData = masterSheet.getDataRange().getValues();
  const header = allData[0];

  const passportIndex = header.indexOf("Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ø²");
  const dateIndex = header.indexOf("Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø¨ØµÙ…Ø©");
  let statusIndex = header.indexOf("ØªÙ… Ø§Ù„Ù†Ù‚Ù„");
  const startCol = 2;

  if (statusIndex === -1) {
    statusIndex = header.length;
    masterSheet.getRange(1, statusIndex + 1).setValue("ØªÙ… Ø§Ù„Ù†Ù‚Ù„");
  }

  const excludeColumns = ["ØªÙ… Ø§Ù„Ù†Ù‚Ù„", "Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø¨ØµÙ…Ø©"];
  const allowedHeader = header
    .map((col, idx) => ({ name: col, idx }))
    .filter((col) => col.idx >= startCol && !excludeColumns.includes(col.name));
  const allowedIndexes = allowedHeader.map(col => col.idx);
  let cleanHeader = allowedHeader.map(col => col.name);

  const birthDateIndexInAllowed = cleanHeader.indexOf("ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯");
  if (birthDateIndexInAllowed !== -1) {
    cleanHeader.splice(birthDateIndexInAllowed + 1, 0, "Ø§Ù„Ø¹Ù…Ø±");
  }

  for (let i = 1; i < allData.length; i++) {
    const row = allData[i];
    const passport = row[passportIndex];
    const date = row[dateIndex];
    const status = row[statusIndex];

    if (!passport || !date || status === "âœ…") continue;

    const sheetNameFull = date.toString().trim();
    const baseName = sheetNameFull.replace(/\(\d+\)/, '').trim();

    let target = sheet.getSheets().find(s => s.getName().startsWith(baseName));

    if (!target) {
      target = sheet.insertSheet(sheetNameFull);
      target.setFrozenRows(1);
      const freezeUntil = cleanHeader.indexOf("ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¬ÙˆØ§Ø²") + 1;
      if (freezeUntil > 1) target.setFrozenColumns(freezeUntil);
      target.getRange(1, 1, 1, cleanHeader.length).setValues([cleanHeader]);

      for (let c = 0; c < cleanHeader.length; c++) {
        const originalIndex = (c <= birthDateIndexInAllowed)
          ? allowedIndexes[c]
          : allowedIndexes[c - 1];
        if (originalIndex !== undefined) {
          const sourceCell = masterSheet.getRange(1, originalIndex + 1);
          const targetCell = target.getRange(1, c + 1);
          sourceCell.copyTo(targetCell, SpreadsheetApp.CopyPasteType.PASTE_FORMAT, false);
          targetCell.setWrapStrategy(SpreadsheetApp.WrapStrategy.CLIP);
          target.setColumnWidth(c + 1, masterSheet.getColumnWidth(originalIndex + 1));
        } else {
          target.setColumnWidth(c + 1, 100);
        }
      }
    }

    let passportExists = false;
    for (const currentSheet of sheet.getSheets()) {
      if (currentSheet.getName() === "Ø§Ù„ÙˆØ±Ù‚Ø©6") continue;
      const sheetData = currentSheet.getDataRange().getValues();
      const passportIdx = sheetData[0].indexOf("Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ø²");
      if (passportIdx !== -1 && sheetData.slice(1).some(r => r[passportIdx] === passport)) {
        passportExists = true;
        break;
      }
    }

    if (!passportExists) {
      const currentCount = target.getLastRow() - 1;
      const maxAllowed = parseInt((target.getName().match(/\((\d+)\)/) || [])[1]) || 30;
      if (currentCount >= maxAllowed) {
        SpreadsheetApp.getActive().toast(`âŒ ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ (${maxAllowed}) ÙÙŠ Ø§Ù„ÙˆØ±Ù‚Ø©: ${target.getName()}`, "ØªÙ†Ø¨ÙŠÙ‡", 6);
        continue;
      }

      let cleanRow = allowedIndexes.map(idx => row[idx]);

      // ğŸŸ¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…Ø±
      let birthDateValue = cleanRow[birthDateIndexInAllowed];
      let age = "";
      if (typeof birthDateValue === "string") birthDateValue = new Date(birthDateValue);
      if (birthDateValue instanceof Date && !isNaN(birthDateValue)) {
        const today = new Date();
        age = today.getFullYear() - birthDateValue.getFullYear();
        const m = today.getMonth() - birthDateValue.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birthDateValue.getDate())) age--;
      }
      cleanRow.splice(birthDateIndexInAllowed + 1, 0, age);

      // ğŸ” ÙƒÙˆØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ
      const pickupCodeIndex = cleanHeader.indexOf("ÙƒÙˆØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…");
      if (pickupCodeIndex !== -1) {
        const randomCode = Math.floor(1000 + Math.random() * 9000);
        cleanRow.splice(pickupCodeIndex, 0, randomCode);
      }

      // â¬‡ï¸ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      const targetRowNum = target.getLastRow() + 1;
      target.getRange(targetRowNum, 1, 1, cleanRow.length).setValues([cleanRow]);
const ageCell = target.getRange(targetRowNum, birthDateIndexInAllowed + 2);
const ageNum = Number(age);
if (!isNaN(ageNum) && age !== "") {
  if (ageNum < 7) {
    ageCell.setBackground("#FFE0B2"); // Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ ÙØ§ØªØ­
  } else if (ageNum < 12) {
    ageCell.setBackground("#BBDEFB"); // Ø£Ø²Ø±Ù‚ ÙØ§ØªØ­
  }
}



      // ğŸ“‹ Ù†Ø³Ø® Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ù…Ù† Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
      const formatSourceRange = masterSheet.getRange(2, startCol + 1, 1, cleanRow.length);
      const formatTargetRange = target.getRange(targetRowNum, 1, 1, cleanRow.length);
      formatSourceRange.copyTo(formatTargetRange, SpreadsheetApp.CopyPasteType.PASTE_FORMAT, false);

      // ğŸ”» Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ù…ÙˆØ¹Ø¯
      const changeColIndex = cleanHeader.indexOf("Ø¥Ø¬Ø±Ø§Ø¡ ØªØºÙŠÙŠØ± Ø§Ù„Ù…ÙˆØ¹Ø¯");
      if (changeColIndex !== -1) {
        const allSheetNames = sheet.getSheets().map(s => s.getName()).filter(n => n !== "Ø§Ù„ÙˆØ±Ù‚Ø©6");
        allSheetNames.push("Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…ÙˆØ¹Ø¯");
        const rule = SpreadsheetApp.newDataValidation()
          .requireValueInList(allSheetNames, true)
          .setAllowInvalid(false).build();
        const col = changeColIndex + 1;
        const targetRange = target.getRange(2, col, target.getLastRow() - 1);
        targetRange.setDataValidation(rule);
      }

      // âœ… Checkboxes
      const checkboxCols = [
        "Ø±Ø³Ø§Ù„Ø© Ø·Ù„Ø¨ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø£ÙˆØ±Ø§Ù‚",
        "Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ£Ø¬ÙŠÙ„",
        "Ø±Ø³Ø§Ù„Ø© Ø§Ù‚Ø±Ø§Ø± Ø¨Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ÙˆØ±Ù‚",
        "Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¹Ø¯",
        "Ø±Ø³Ø§Ù„Ø© ØªÙ… Ø§Ù„ØªØ¨ØµÙŠÙ…",
        "Ø±Ø³Ø§Ù„Ø© Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ø²",
        "ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…"
      ];
      checkboxCols.forEach(colName => {
        const colIndex = cleanHeader.indexOf(colName);
        if (colIndex !== -1) target.getRange(targetRowNum, colIndex + 1).insertCheckboxes();
      });

      // âœ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‚Ù„
      masterSheet.getRange(i + 1, statusIndex + 1).setValue("âœ…");

      // âœ‰ï¸ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²
      const nameIndex = cleanHeader.indexOf("Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ø¬ÙˆØ§Ø²");
      const phoneIndex = cleanHeader.indexOf("Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„");
      const statusConfirmIndex = cleanHeader.indexOf("Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²");

      let confirmPhone = cleanRow[phoneIndex];
      let confirmName = cleanRow[nameIndex];
      if (confirmPhone && statusConfirmIndex !== -1) {
        confirmPhone = confirmPhone.toString().trim().replace(/^0+/, "");
        if (!confirmPhone.startsWith("966")) confirmPhone = "966" + confirmPhone;

        const visaDateMatch = sheetNameFull.match(/^(\d+)([A-Z]{3})/);
        let visaDate = "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
        if (visaDateMatch) {
          const day = visaDateMatch[1];
          const monthEng = visaDateMatch[2];
          const monthMap = {
            JAN: "ÙŠÙ†Ø§ÙŠØ±", FEB: "ÙØ¨Ø±Ø§ÙŠØ±", MAR: "Ù…Ø§Ø±Ø³", APR: "Ø£Ø¨Ø±ÙŠÙ„",
            MAY: "Ù…Ø§ÙŠÙˆ", JUN: "ÙŠÙˆÙ†ÙŠÙˆ", JUL: "ÙŠÙˆÙ„ÙŠÙˆ", AUG: "Ø£ØºØ³Ø·Ø³",
            SEP: "Ø³Ø¨ØªÙ…Ø¨Ø±", OCT: "Ø£ÙƒØªÙˆØ¨Ø±", NOV: "Ù†ÙˆÙÙ…Ø¨Ø±", DEC: "Ø¯ÙŠØ³Ù…Ø¨Ø±"
          };
          visaDate = `*${day} ${monthMap[monthEng] || monthEng}*`;
        }

        const message =
          `ğŸ“Œ Ù…Ø±Ø­Ø¨Ù‹Ø§ *${confirmName || ""}*ØŒ\n` +
          `ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø¨ØµÙ…Ø© Ø§Ù„Ø´Ù†ØºÙ† Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ø¨ØªØ§Ø±ÙŠØ® ${visaDate}.\n\n` +
          `Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…ÙˆØ¸Ù ÙÙŠ Ø­Ø§Ù„ Ø§Ù„Ø­Ø§Ø¬Ø© Ù„Ø£ÙŠ ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©.\n` +
          `âš ï¸ Ù‡Ø°Ù‡ Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø¢Ù„ÙŠØ© ÙˆÙ„Ø§ ÙŠØ¬Ø¨ Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§.`;

        const body = {
          number: confirmPhone,
          text: message
        };

        const options = {
          method: 'post',
          contentType: 'application/json',
          headers: { 'apikey': EVOLUTION_API_KEY },
          payload: JSON.stringify(body),
          muteHttpExceptions: true
        };

        let sendStatus = "âŒ";
        try {
          const response = UrlFetchApp.fetch(EVOLUTION_API_URL, options);
          const json = JSON.parse(response.getContentText());
          sendStatus = (json.status === "PENDING" || json.status === "success") ? "âœ…" : "âŒ";
        } catch (err) {}

        if (sendStatus === "âŒ") {
          Utilities.sleep(5000);
          try {
            const retryResponse = UrlFetchApp.fetch(EVOLUTION_API_URL, options);
            const retryJson = JSON.parse(retryResponse.getContentText());
            sendStatus = (retryJson.status === "PENDING" || retryJson.status === "success") ? "âœ…" : "âŒ";
          } catch (retryErr) {}
        }

        target.getRange(targetRowNum, statusConfirmIndex + 1).setValue(sendStatus);

        Logger.log(
          `ğŸ“„ [${sheetNameFull}]\nğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${confirmName}\nğŸ“± Ø§Ù„Ø¬ÙˆØ§Ù„: ${confirmPhone}\nğŸ“¨ Ø§Ù„Ø­Ø§Ù„Ø©: ${sendStatus}\n---\n${message}\n==========================\n`
        );
      }
    }
  }
}
