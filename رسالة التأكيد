
function sendBookingConfirmationMessage() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet();
  const allSheets = sheet.getSheets();

  allSheets.forEach(activeSheet => {
    const sheetNameFull = activeSheet.getName();
    if (sheetNameFull === "Ø§Ù„ÙˆØ±Ù‚Ø©6") return;

    const data = activeSheet.getDataRange().getValues();
    if (data.length < 2) return;

    const header = data[0];
    const nameIndex = header.indexOf("Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ø¬ÙˆØ§Ø²");
    const phoneIndex = header.indexOf("Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„");
    const statusConfirmIndex = header.indexOf("Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²");

    if (nameIndex === -1 || phoneIndex === -1 || statusConfirmIndex === -1) {
      Logger.log(`âŒ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø© ÙÙŠ Ø§Ù„ÙˆØ±Ù‚Ø©: ${sheetNameFull}`);
      return;
    }

    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      let confirmPhone = row[phoneIndex];
      let confirmName = row[nameIndex];
      const currentStatus = row[statusConfirmIndex];

      // âœ… ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØµÙ Ø¥Ø°Ø§ ÙƒØ§Ù† ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§ Ø£Ùˆ ÙØ´Ù„ (âœ… Ø£Ùˆ âŒ)
      if (!confirmPhone || currentStatus === "âœ…" || currentStatus === "âŒ") continue;

      confirmPhone = confirmPhone.toString().trim().replace(/^0+/, "");
      if (!confirmPhone.startsWith("966")) confirmPhone = "966" + confirmPhone;

      const visaDateMatch = sheetNameFull.match(/^(\d+)([A-Z]{3})/);
      let visaDate = "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
      if (visaDateMatch) {
        const day = visaDateMatch[1];
        const monthEng = visaDateMatch[2];
        const monthMap = {
          JAN: "ÙŠÙ†Ø§ÙŠØ±", FEB: "ÙØ¨Ø±Ø§ÙŠØ±", MAR: "Ù…Ø§Ø±Ø³", APR: "Ø£Ø¨Ø±ÙŠÙ„",
          MAY: "Ù…Ø§ÙŠÙˆ", JUN: "ÙŠÙˆÙ†ÙŠÙˆ", JUL: "ÙŠÙˆÙ„ÙŠÙˆ", AUG: "Ø£ØºØ³Ø·Ø³",
          SEP: "Ø³Ø¨ØªÙ…Ø¨Ø±", OCT: "Ø£ÙƒØªÙˆØ¨Ø±", NOV: "Ù†ÙˆÙÙ…Ø¨Ø±", DEC: "Ø¯ÙŠØ³Ù…Ø¨Ø±"
        };
        visaDate = `*${day} ${monthMap[monthEng] || monthEng}*`;
      }

      const message =
        `ðŸ“Œ Ù…Ø±Ø­Ø¨Ù‹Ø§ *${confirmName || ""}*ØŒ\n` +
        `ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø¨ØµÙ…Ø© Ø§Ù„Ø´Ù†ØºÙ† Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ø¨ØªØ§Ø±ÙŠØ® ${visaDate}.\n\n` +
        `Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…ÙˆØ¸Ù ÙÙŠ Ø­Ø§Ù„ Ø§Ù„Ø­Ø§Ø¬Ø© Ù„Ø£ÙŠ ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©.\n` +
        `âš ï¸ Ù‡Ø°Ù‡ Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø¢Ù„ÙŠØ© ÙˆÙ„Ø§ ÙŠØ¬Ø¨ Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§.`;

      const body = {
        number: confirmPhone,
        text: message
      };

      const options = {
        method: 'post',
        contentType: 'application/json',
        headers: { 'apikey': EVOLUTION_API_KEY },
        payload: JSON.stringify(body),
        muteHttpExceptions: true
      };

      let sendStatus = "âŒ";
      try {
        const response = UrlFetchApp.fetch(EVOLUTION_API_URL, options);
        const json = JSON.parse(response.getContentText());
        sendStatus = (json.status === "PENDING" || json.status === "success") ? "âœ…" : "âŒ";
      } catch (err) {}

      // ðŸ›‘ Ù„Ø§ Ù†Ø­Ø§ÙˆÙ„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙÙŠ Ø­Ø§Ù„ ÙØ´Ù„
    activeSheet.getRange(i + 1, statusConfirmIndex + 1).setValue(sendStatus);

    Logger.log(
      `ðŸ“„ [${sheetNameFull}]\nðŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${confirmName}\nðŸ“± Ø§Ù„Ø¬ÙˆØ§Ù„: ${confirmPhone}\nðŸ“¨ Ø§Ù„Ø­Ø§Ù„Ø©: ${sendStatus}\n---\n${message}\n==========================\n`
    );

    // â±ï¸ ØªØ£Ø®ÙŠØ± Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ø¨ÙŠÙ† 6 Ø¥Ù„Ù‰ 11 Ø«Ø§Ù†ÙŠØ©
    const delay = Math.floor(Math.random() * (11000 - 6000 + 1)) + 6000;
    Utilities.sleep(delay);
      
    }
  });

  SpreadsheetApp.getActive().toast("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ù†Ø¬Ø§Ø­ (Ø¹Ø¯Ø§ âœ… Ùˆ âŒ)");
}
